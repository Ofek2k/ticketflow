<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>TicketFlow - Cyber Ops</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    /* --- ××©×ª× ×™× ×•×¢×™×¦×•×‘ Midnight Neon --- */
    :root {
      --bg-dark: #020617;
      --bg-pink: #831843;
      --text: #f8fafc;
      --text-soft: #cbd5e1;
      --accent: #ec4899;
      --glass-bg: rgba(30, 41, 59, 0.6); 
      --glass-border: rgba(255, 255, 255, 0.2);
      --border: rgba(255, 255, 255, 0.1);
      --urgent: #ef4444; 
      --new: #10b981;    
    }
    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0; padding: 0;
      font-family: 'Heebo', sans-serif;
      background-color: var(--bg-dark);
      color: var(--text);
      min-height: 100vh;
      display: flex; align-items: stretch; justify-content: center;
      background-image: 
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400' viewBox='0 0 800 800'%3E%3Cg fill='none' stroke='%23FFFFFF' stroke-width='1.5' stroke-opacity='0.35'%3E%3Cpath d='M769 229L1037 260.9M927 880L731 737 520 660 309 538 40 599 295 764 126 552 20 570 71 613 15 236 56 214 186 319 243 412 191 501 10 300 200 400 300 500 400 600 500 700 600 800 700 800 800 700 900 600 1000 500'/%3E%3C/g%3E%3C/svg%3E"),
        linear-gradient(135deg, var(--bg-dark) 0%, #1e1b4b 50%, var(--bg-pink) 100%);
      background-size: 600px 600px, cover;
      background-repeat: repeat, no-repeat;
      background-position: 0 0, center;
      animation: contourMove 60s linear infinite;
    }
    @keyframes contourMove { 0% { background-position: 0 0, center; } 100% { background-position: 600px 600px, center; } }

    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }

    .app-root { width: 100%; max-width: 100%; margin: 0; overflow: hidden; background: rgba(15, 23, 42, 0.3); backdrop-filter: blur(8px); display: flex; flex-direction: row; height: 100vh; position: relative; }
    .sidebar { width: 280px; background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(20px); border-inline-start: 1px solid var(--glass-border); padding: 24px 20px; display: flex; flex-direction: column; gap: 24px; flex-shrink: 0; z-index: 2000; }
    
    .card { background: var(--glass-bg); border: 1px solid var(--glass-border); border-top: 1px solid rgba(255, 255, 255, 0.3); border-radius: 24px; padding: 32px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); backdrop-filter: blur(20px); transition: transform 0.3s, box-shadow 0.3s; width: 100%; }
    .card-title { font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
    
    .list-item { display: flex; align-items: center; justify-content: space-between; padding: 20px; background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); border-radius: 18px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s; animation: fade-in-up 0.4s ease-out forwards; opacity: 0; transform: translateY(10px); position: relative; overflow: hidden; }
    .list-item:hover { background: rgba(255,255,255,0.1); border-color: #fff; transform: scale(1.005); box-shadow: 0 0 20px rgba(236, 72, 153, 0.1); }
    
    .ticket-urgent { border: 1px solid var(--urgent) !important; background: rgba(239, 68, 68, 0.08) !important; box-shadow: 0 0 20px rgba(239, 68, 68, 0.25) !important; }
    .ticket-hamal { border: 2px solid #ef4444 !important; background: rgba(239, 68, 68, 0.15) !important; animation: pulseRed 1.5s infinite; }
    @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
    .ticket-new { border-right: 3px solid var(--new) !important; }

    @keyframes fade-in-up { to { opacity: 1; transform: translateY(0); } }

    .btn { display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; border-radius: 14px; font-size: 0.9rem; font-weight: 600; cursor: pointer; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.05); color: var(--text); transition: all 0.2s; }
    .btn:hover { background: rgba(255,255,255,0.15); border-color: #fff; transform: translateY(-2px); }
    .btn-primary { background: var(--accent); border: 1px solid var(--accent); color: #fff; box-shadow: 0 0 20px rgba(236, 72, 153, 0.3); font-weight: 700; }
    .btn-primary:hover { background: #db2777; box-shadow: 0 0 40px rgba(236, 72, 153, 0.6); transform: translateY(-2px) scale(1.02); }
    .btn-danger { color: #ef4444; border-color: #ef4444; background: rgba(239,68,68,0.1); } .btn-danger:hover { background: #ef4444; color: #fff; }
    .btn-ghost { background: transparent; border: none; color: var(--text-soft); }
    .btn-ghost:hover { background: rgba(255,255,255,0.1); color: white; }

    .input, .select, .textarea { width: 100%; background: rgba(15, 23, 42, 0.6); border: 1px solid var(--glass-border); border-radius: 14px; padding: 14px 18px; color: #fff; font-family: inherit; font-size: 0.95rem; transition: 0.2s; }
    .input:focus, .select:focus, .textarea:focus { border-color: var(--accent); box-shadow: 0 0 15px rgba(236, 72, 153, 0.3); background: rgba(15, 23, 42, 0.8); }
    .select option { background-color: var(--bg-dark); color: #fff; }
    .select.active-filter { border-color: #ec4899 !important; color: #ec4899 !important; font-weight: 600; }

    .main { flex: 1; padding: 40px; overflow-y: auto; display: flex; flex-direction: column; gap: 24px; position: relative; }
    .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; } 
    .page-title { font-size: 1.8rem; font-weight: 800; letter-spacing: -0.8px; } 
    .page-subtitle { font-size: 0.95rem; color: var(--text-soft); margin-top: 4px; }
    .badge { padding: 4px 10px; border-radius: 8px; font-size: 0.7rem; font-weight: 700; border: 1px solid currentColor; display: inline-flex; align-items: center; gap: 6px; }
    .badge-OPEN { color: #60a5fa; } .badge-IN_PROGRESS { color: #fbbf24; } .badge-RESOLVED { color: #4ade80; } .badge-CLOSED { color: #94a3b8; border-color: rgba(255,255,255,0.2); box-shadow: none; }
    .chat-bubble { background: rgba(255,255,255,0.05); border-radius: 18px; padding: 16px; margin-bottom: 14px; border: 1px solid var(--glass-border); } 
    .chat-meta { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-size: 0.8rem; color: var(--text-soft); } 
    
    .file-upload-label { display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px; border: 1px dashed var(--glass-border); border-radius: 14px; transition: 0.2s; color: var(--text-soft); background: rgba(0,0,0,0.3); } 
    .file-upload-label:hover { border-color: var(--accent); color: var(--text); background: rgba(236,72,153,0.1); }
    .ticket-image-preview { width: 100%; max-height: 300px; object-fit: cover; border-radius: 12px; margin-top: 12px; border: 1px solid var(--glass-border); cursor: pointer; }

    .login-wrap { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; } 
    .login-box { width: 100%; max-width: 440px; padding: 48px; background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(30px); border: 1px solid var(--glass-border); border-radius: 32px; box-shadow: 0 40px 80px -20px rgba(0,0,0,0.8); text-align: center; } 
    .login-icon { width: 72px; height: 72px; background: linear-gradient(135deg, #ec4899, #8b5cf6); border-radius: 24px; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; box-shadow: 0 0 30px rgba(236,72,153,0.6); color: white; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 9999; display: flex; align-items: center; justify-content: center; animation: fade 0.2s; } 
    .modal { background: var(--bg-dark); border: 1px solid rgba(255,255,255,0.2); width: 90%; max-width: 400px; padding: 32px; border-radius: 28px; text-align: center; box-shadow: 0 0 50px rgba(0,0,0,0.8); animation: pop 0.3s cubic-bezier(0.16, 1, 0.3, 1); } 
    @keyframes pop { from { opacity: 0; transform: scale(0.9) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } } @keyframes fade { from { opacity: 0; } to { opacity: 1; } }
    .loader-wrap { position: absolute; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 50; border-radius: inherit; } 
    .spinner { width: 44px; height: 44px; border: 3px solid rgba(236,72,153,0.1); border-top-color: #ec4899; border-radius: 50%; animation: spin 0.8s linear infinite; box-shadow: 0 0 15px rgba(236, 72, 153, 0.4); } 
    @keyframes spin { to { transform: rotate(360deg); } }
    .toast { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); background: #1e293b; color: #fff; padding: 14px 28px; border-radius: 99px; box-shadow: 0 0 20px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 12px; z-index: 10000; font-weight: 500; animation: slide-up-fade 0.4s cubic-bezier(0.16, 1, 0.3, 1); } 
    @keyframes slide-up-fade { from { opacity: 0; transform: translate(-50%, 20px); } to { opacity: 1; transform: translate(-50%, 0); } }
    
    /* --- Dashboard Grid Fix --- */
    .grid-dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; } 
    .stat-card { background: rgba(255,255,255,0.05); padding: 24px; border-radius: 24px; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 6px; box-shadow: 0 8px 20px rgba(0,0,0,0.3); } 
    .stat-val { font-size: 2.2rem; font-weight: 800; line-height: 1; text-shadow: 0 0 10px currentColor; } 
    .stat-lbl { font-size: 0.8rem; color: var(--text-soft); font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
    
    /* --- Analytics New Styles --- */
    .grid-dashboard-compact { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .stat-card-compact { background: rgba(255,255,255,0.05); padding: 16px; border-radius: 20px; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 4px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    .stat-val-compact { font-size: 1.8rem; font-weight: 800; line-height: 1; text-shadow: 0 0 15px currentColor; }
    .stat-lbl-compact { font-size: 0.75rem; color: var(--text-soft); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    
    .date-control-bar { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 8px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--border); flex-wrap: wrap; gap: 10px; }
    .date-nav-btn { background: transparent; border: none; color: var(--text); padding: 8px; border-radius: 8px; cursor: pointer; transition: 0.2s; }
    .date-nav-btn:hover { background: rgba(255,255,255,0.1); }
    .view-toggle-btn { padding: 6px 12px; border-radius: 8px; font-size: 0.8rem; font-weight: 600; cursor: pointer; border: 1px solid transparent; background: transparent; color: var(--text-soft); transition: 0.2s; }
    .view-toggle-btn.active { background: var(--accent); color: white; box-shadow: 0 0 10px rgba(236, 72, 153, 0.4); }

    .analytics-filter-toggle { display: flex; gap: 10px; margin-bottom: 24px; } 
    .analytics-filter-chip { padding: 8px 16px; border-radius: 10px; border: 1px solid var(--border); background: transparent; color: var(--text-soft); cursor: pointer; font-size: 0.9rem; transition: 0.2s; } 
    .analytics-filter-chip.active { background: rgba(236,72,153,0.2); color: #fff; border-color: rgba(236,72,153,0.4); box-shadow: 0 0 10px rgba(236,72,153,0.2); } 
    .pie-slice { transition: transform 0.2s ease-out; cursor: pointer; transform-origin: center; transform-box: fill-box; } 
    .pie-slice:hover { transform: scale(1.05); filter: drop-shadow(0 0 8px rgba(236,72,153,0.6)); } 
    .chart-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 32px; } @media(max-width:900px){ .chart-grid-2 { grid-template-columns: 1fr; } }

    .grid-2cols { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; width: 100%; } @media(max-width:700px){ .grid-2cols { grid-template-columns: 1fr; gap: 20px; } }
    .field-group { margin-bottom: 20px; width: 100%; } .label { display: block; font-size: 0.8rem; font-weight: 600; color: var(--text-soft); margin-bottom: 8px; }

    .brand { display: flex; align-items: center; gap: 12px; padding: 0 8px; margin-bottom: 8px; } 
    .brand img { width: 42px; height: 42px; filter: drop-shadow(0 0 20px rgba(236,72,153,0.6)); } 
    .brand-title { font-weight: 800; font-size: 1.2rem; letter-spacing: -0.5px; background: linear-gradient(to right, #fff, #ec4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .nav-group { display: flex; flex-direction: column; gap: 6px; } 
    .nav-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-soft); padding: 0 12px; margin-bottom: 4px; font-weight: 600; opacity: 0.6; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 14px; cursor: pointer; color: var(--text-soft); font-size: 0.9rem; font-weight: 500; transition: all 0.2s; border: 1px solid transparent; } 
    .nav-item:hover { background: rgba(255,255,255,0.1); color: #fff; transform: translateX(-4px); } 
    .nav-item.active { background: linear-gradient(90deg, rgba(236,72,153,0.2), transparent); color: #fff; border-color: rgba(236,72,153,0.4); box-shadow: 0 0 20px rgba(236, 72, 153, 0.15); } 
    .nav-item svg { width: 20px; height: 20px; transition: transform 0.2s; } 
    .nav-item.active svg { color: var(--accent); transform: scale(1.1); filter: drop-shadow(0 0 8px var(--accent)); }
    .notification-dot { width: 8px; height: 8px; background: var(--urgent); border-radius: 50%; margin-left: auto; box-shadow: 0 0 5px var(--urgent); }

    /* × ×™×”×•×œ ××©×ª××©×™× */
    .table-responsive { overflow-x: auto; }
    .table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.9rem; }
    .table th { text-align: right; padding: 16px; color: var(--text-soft); border-bottom: 1px solid var(--border); }
    .table td { padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255,255,255,0.2); transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--new); }
    input:checked + .slider:before { transform: translateX(18px); }

    .user-card { margin-top: auto; background: rgba(255,255,255,0.05); padding: 12px; border-radius: 16px; display: flex; align-items: center; gap: 12px; border: 1px solid var(--glass-border); }
    .avatar { width: 40px; height: 40px; border-radius: 12px; background: linear-gradient(135deg, #ec4899, #8b5cf6); color: #fff; font-weight: 700; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 20px rgba(236,72,153,0.4); font-size: 1rem; flex-shrink: 0; }
    .user-info { flex: 1; min-width: 0; text-align: right; }
    .user-name { font-size: 0.9rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-role { font-size: 0.75rem; color: var(--text-soft); }
    .logout-btn { background: transparent; border: none; color: var(--text-soft); cursor: pointer; padding: 8px; border-radius: 10px; transition: 0.2s; }
    .logout-btn:hover { background: rgba(244,63,94,0.15); color: #f43f5e; box-shadow: 0 0 15px rgba(244, 63, 94, 0.3); }

    @media (max-width: 900px) {
      .app-root { flex-direction: column; height: 100vh; overflow: hidden; } 
      .main { padding: 16px; padding-bottom: 80px; width: 100%; overflow-y: auto; }
      .sidebar { top: auto; bottom: 0; left: 0; right: 0; width: 100vw; height: 60px; transform: none; background: rgba(15, 23, 42, 0.95); border-top: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: row; overflow-x: auto; padding: 0; z-index: 9999; }
      .sidebar .brand, .sidebar .user-card, .sidebar .nav-label { display: none !important; }
      .nav-group { display: contents; }
      .nav-item { display: inline-flex; align-items: center; justify-content: center; flex: 0 0 auto; height: 100%; padding: 0 16px; background: transparent !important; border: none; margin: 0; }
      .nav-item svg { display: none !important; }
      .nav-item.active { color: #fff; background: linear-gradient(to bottom, rgba(236,72,153,0.2), transparent) !important; border-top: 3px solid #ec4899; }
      .nav-item[onclick*="CREATE"] span { display: block !important; }
    }
  </style>
</head>
<body>
<div id="root"></div>
<div id="modal-root"></div>
<div id="toast-root"></div>

<script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>

<script>
  const SUPABASE_URL = "https://tymratzaavokyhbcycgb.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR5bXJhdHphYXZva3loYmN5Y2diIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNTE0ODIsImV4cCI6MjA4MDYyNzQ4Mn0.Y73HK3Jgg1FD--o3KMt3A-GbY8S2hfRyr6M-IABu6NY";
  const PUSH_WORKER_BASE = "https://ticketflow-push.galaxyskin350.workers.dev";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let currentUser = null, users = [], tickets = [], comments = [], units = [], activePage = "HOME";
  let showClosed = false, selectedTicketId = null, analyticsDim = "STATUS", fetchLimit = 100;
  
  let analyticsView = 'WEEK'; 
  let analyticsRefDate = new Date(); 
  let isRecoveryMode = false; // Flag for password reset

  const escapeHtml = (str) => String(str||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
  const formatDate = (ts) => ts ? new Date(ts).toLocaleString("he-IL", {dateStyle:"short", timeStyle:"short"}) : "";
  const roleLabel = (r) => ({OWNER:"×‘×¢×œ×™×", COMPANY_CMD:'×"×¤', HATAP:'×—×˜"×¤', HR:'××©"×', USER:"××©×ª××©", PLHIK:'×¤×œ×—×™"×§', MAMRAM:'×××¨"×', APP:'××¤×œ×™×§×¦×™×”', NETWORK:'×¨×©×ª'}[r] || r);
  const STATUS_LABEL = { OPEN:"×¤×ª×•×—", IN_PROGRESS:"×‘×˜×™×¤×•×œ", RESOLVED:"×˜×•×¤×œ", CLOSED:"×¡×’×•×¨" };

  function timeAgo(dateParam) {
    if(!dateParam) return null;
    const date = new Date(dateParam);
    const now = new Date();
    const minutes = Math.floor((now - date) / 1000 / 60);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);
    if (minutes < 60) return `×œ×¤× ×™ ${minutes} ×“×§'`;
    if (hours < 24) return `×œ×¤× ×™ ${hours} ×©×¢×•×ª`;
    return `×œ×¤× ×™ ${days} ×™××™×`;
  }
  
  function isOverHour(dateParam) {
    if(!dateParam) return false;
    return (new Date() - new Date(dateParam)) > 60 * 60 * 1000;
  }

  function showToast(msg, icon="check") { const el = document.createElement("div"); el.className="toast"; el.innerHTML = `<i data-lucide="${icon}"></i><span>${msg}</span>`; document.getElementById("toast-root").appendChild(el); lucide.createIcons(); setTimeout(() => el.remove(), 3000); }
  function showModal(title, msg, isErr=false) { return new Promise(resolve => { const root = document.getElementById("modal-root"); root.innerHTML = `<div class="modal-overlay"><div class="modal" style="border-color:${isErr?'#f43f5e':'rgba(255,255,255,0.1)'}"><div style="font-size:3rem;margin-bottom:10px;">${isErr?'ğŸ˜“':'âœ¨'}</div><div style="font-size:1.2rem;font-weight:800;margin-bottom:8px;">${title}</div><div style="color:#94a3b8;margin-bottom:24px;line-height:1.5;">${msg}</div><button class="btn btn-primary" style="width:100%;justify-content:center;" id="mod-ok">×”×‘× ×ª×™, ×¡×’×•×¨</button></div></div>`; document.getElementById("mod-ok").onclick = () => { root.innerHTML=""; resolve(); }; }); }
  async function withLoader(el, fn) { const l = document.createElement("div"); l.className="loader-wrap"; l.innerHTML=`<div class="spinner"></div>`; if(getComputedStyle(el).position==="static") el.style.position="relative"; el.appendChild(l); try { await fn(); } catch(e) { console.error(e); showModal("×©×’×™××”", e.message, true); } finally { if(l.parentNode===el) el.removeChild(l); } }

  async function loadData() {
    const {data:{user}} = await supabase.auth.getUser();
    if(!user) return null;
    const [uRes, tRes, cRes, unRes] = await Promise.all([ 
        supabase.from("users").select("*"), 
        supabase.from("tickets").select("*").order("created_at",{ascending:false}).limit(fetchLimit), 
        supabase.from("ticket_comments").select("*"), 
        supabase.from("units").select("*") 
    ]);
    
    users = (uRes.data || []).map(u => ({ id: u.id, authUserId: u.auth_user_id, fullName: u.full_name, email: u.email, phone: u.phone, role: u.role, isManager: u.is_manager, requestedManager: u.requested_manager, unit: u.unit, unitId: u.unit_id, requestedRole: u.requested_role, roleStatus: u.role_status, isFrozen: u.is_frozen }));
    tickets = (tRes.data || []).map(t => ({ id: t.id, ticketNumber: t.ticket_number, title: t.title, description: t.description, topic: t.topic, status: t.status, unit: t.unit, assignedRole: t.assigned_role, assignedUserId: t.assigned_user_id, createdByUserId: t.created_by_user_id, createdByName: t.created_by_name, isClosed: !!t.is_closed || t.status === 'RESOLVED' || t.status === 'CLOSED', createdAt: t.created_at, imageUrl: t.image_url, isHamalDown: t.is_hamal_down }));
    comments = cRes.data || [];
    units = unRes.data || [];
    currentUser = users.find(u => u.authUserId === user.id);
    
    if(currentUser && currentUser.isFrozen) {
        await supabase.auth.signOut();
        alert("×”×—×©×‘×•×Ÿ ×”×•×§×¤×. ×¤× ×” ×œ×× ×”×œ ×”××¢×¨×›×ª.");
        location.reload();
        return null;
    }
    if(currentUser) ensurePushAutoForUser(currentUser.id).catch(console.error);
    return currentUser;
  }
  
  window.loadMoreData = async () => { fetchLimit += 50; await loadData(); renderPage(); };
  
  // ×–×™×”×•×™ ××¦×‘ ×©×—×–×•×¨ ×¡×™×¡××” ××”-URL
  function checkRecoveryMode() {
      // Supabase ××•×¡×™×£ hash ×œ-URL ×›×©×—×•×–×¨×™× ×××™××™×™×œ
      // ×œ×“×•×’××”: #access_token=...&type=recovery
      const hash = window.location.hash;
      if (hash && hash.includes('type=recovery')) {
          isRecoveryMode = true;
          console.log("Recovery mode detected from URL hash");
      }
  }

  function setupRealtime() { 
      supabase.channel('public:tickets').on('postgres_changes', { event: '*', schema: 'public', table: 'tickets' }, async () => { 
          await loadData(); render(); showToast("×”× ×ª×•× ×™× ×”×ª×¢×“×›× ×•", "refresh-cw"); 
      }).subscribe();
      
      // ×’×™×‘×•×™ ×œ××§×¨×” ×©×”-Hash ×œ× × ×ª×¤×¡, ×œ×¤×¢××™× ×”××™×¨×•×¢ ××’×™×¢ ×-Supabase
      supabase.auth.onAuthStateChange((event, session) => {
          if (event === 'PASSWORD_RECOVERY') {
              isRecoveryMode = true;
              render();
          }
      });
  }

  function render() { 
      // ×× ×× ×—× ×• ×‘××¦×‘ ×©×—×–×•×¨ - ×”×¦×’ ×¨×§ ××ª ××¡×š ×”××™×¤×•×¡
      if (isRecoveryMode) {
          return renderResetPassword();
      }
      
      if(!currentUser) return renderLogin(); 
      if(!currentUser.fullName || !currentUser.phone) return renderOnboarding(); 
      renderApp(); 
  }

  // ××¡×š ××™×¤×•×¡ ×¡×™×¡××” ×™×™×¢×•×“×™
  function renderResetPassword() {
      document.getElementById("root").innerHTML = `
      <div class="login-wrap">
          <div class="login-box" style="border-color:#ec4899; box-shadow:0 0 30px rgba(236,72,153,0.2);">
              <div class="login-icon"><i data-lucide="key" style="width:32px;height:32px;"></i></div>
              <h1 style="font-weight:900;font-size:1.8rem;margin-bottom:4px;">××™×¤×•×¡ ×¡×™×¡××”</h1>
              <p style="color:#94a3b8;margin-bottom:30px;">×”×–×Ÿ ×¡×™×¡××” ×—×“×©×” ×›×“×™ ×œ×©×—×–×¨ ××ª ×”×’×™×©×” ×œ×—×©×‘×•×Ÿ</p>
              <form id="reset-form">
                  <div class="field-group" style="text-align:right;">
                      <label class="label">×¡×™×¡××” ×—×“×©×”</label>
                      <input class="input" type="password" name="newPass" required placeholder="×œ×¤×—×•×ª 6 ×ª×•×•×™×" minlength="6" />
                  </div>
                  <button class="btn btn-primary" style="width:100%;justify-content:center;padding:12px;margin-top:10px;">×¢×“×›×Ÿ ×¡×™×¡××” ×•×›× ×¡</button>
              </form>
          </div>
      </div>`;
      lucide.createIcons();
      
      document.getElementById("reset-form").onsubmit = async (e) => {
          e.preventDefault();
          const newPass = e.target.newPass.value;
          await withLoader(document.querySelector(".login-box"), async () => {
              const { error } = await supabase.auth.updateUser({ password: newPass });
              if (error) throw error;
              alert("×”×¡×™×¡××” ×©×•× ×ª×” ×‘×”×¦×œ×—×”! ××¢×‘×™×¨ ××•×ª×š ×œ××¢×¨×›×ª...");
              
              // ×™×¦×™××” ×××¦×‘ ×©×—×–×•×¨ ×•× ×™×§×•×™ ×”-URL
              isRecoveryMode = false;
              window.location.hash = ""; 
              window.location.reload();
          });
      };
  }

  function renderLogin() { document.getElementById("root").innerHTML = `<div class="login-wrap"><div class="login-box"><div class="login-icon"><i data-lucide="shield" style="width:32px;height:32px;"></i></div><h1 style="font-weight:900;font-size:1.8rem;margin-bottom:4px;">TicketFlow</h1><p style="color:#94a3b8;margin-bottom:30px;">××¢×¨×›×ª × ×™×”×•×œ ×ª×§×œ×•×ª ××‘×¦×¢×™×ª</p><form id="auth-form"><div class="field-group" style="text-align:right;"><label class="label">×›×ª×•×‘×ª ××™××™×™×œ</label><input class="input" type="email" name="email" required /></div><div class="field-group" style="text-align:right;"><label class="label">×¡×™×¡××”</label><input class="input" type="password" name="password" required /></div><div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;font-size:0.85rem;"><a href="#" id="forgot-btn" style="color:var(--text-soft);text-decoration:none;">×©×›×—×ª×™ ×¡×™×¡××”?</a></div><button class="btn btn-primary" style="width:100%;justify-content:center;padding:12px;margin-top:20px;">×›× ×™×¡×” ×œ××¢×¨×›×ª</button><div style="margin-top:16px;font-size:0.8rem;"><span style="color:#64748b;">××™×Ÿ ×œ×š ××©×ª××©?</span> <a href="#" id="go-sign" style="color:#ec4899;text-decoration:none;font-weight:600;">×”×¨×©××”</a></div></form></div></div>`; lucide.createIcons(); const form = document.getElementById("auth-form"); form.onsubmit = async (e) => { e.preventDefault(); await withLoader(document.querySelector(".login-box"), async () => { const { error } = await supabase.auth.signInWithPassword({ email: form.email.value, password: form.password.value }); if(error) throw error; await loadData(); setupRealtime(); render(); }); }; document.getElementById("go-sign").onclick = async (e) => { e.preventDefault(); const em = prompt("××™××™×™×œ:"); const pw = prompt("×¡×™×¡××”:"); if(em&&pw) { const {data, error} = await supabase.auth.signUp({email:em, password:pw}); if(!error) { await supabase.from("users").insert({auth_user_id:data.user.id, email:em, role:"USER", role_status:"Pending"}); showModal("× ×¨×©××ª ×‘×”×¦×œ×—×”", "×›×¢×ª × ×™×ª×Ÿ ×œ×”×ª×—×‘×¨."); } else showModal("×©×’×™××”", error.message, true); } }; document.getElementById("forgot-btn").onclick = async (e) => { e.preventDefault(); const em = form.email.value || prompt("×”×›× ×¡ ×›×ª×•×‘×ª ××™××™×™×œ ×œ×©×—×–×•×¨:"); if(!em) return; await withLoader(document.querySelector(".login-box"), async () => { const {error} = await supabase.auth.resetPasswordForEmail(em, { redirectTo: window.location.href }); if(error) showModal("×©×’×™××”", error.message, true); else showModal("×”×•×“×¢×” × ×©×œ×—×”", "×‘×“×•×§ ××ª ×”××™××™×™×œ ×©×œ×š ×œ×§×‘×œ×ª ×§×™×©×•×¨ ×œ××™×¤×•×¡ ×¡×™×¡××”."); }); }; }
  function renderOnboarding() { document.getElementById("root").innerHTML = `<div class="login-wrap"><div class="login-box"><div class="login-icon"><i data-lucide="user-plus"></i></div><h2 style="margin-bottom:10px;">×”×©×œ××ª ×¤×¨×•×¤×™×œ</h2><form id="onb-form" style="text-align:right;"><div class="field-group"><label class="label">×©× ××œ×</label><input class="input" name="fullName" required value="${escapeHtml(currentUser?.fullName||"")}" /></div><div class="field-group"><label class="label">×˜×œ×¤×•×Ÿ</label><input class="input" name="phone" required value="${escapeHtml(currentUser?.phone||"")}" /></div><div class="field-group"><label class="label">×—×˜×™×‘×”</label><select class="select" name="unit"><option value="">×œ×œ×</option>${units.map(u => `<option value="${escapeHtml(u.name)}">${escapeHtml(u.name)}</option>`).join("")}</select></div><button class="btn btn-primary" style="width:100%;justify-content:center;">×©××™×¨×” ×•×”××©×š</button></form></div></div>`; lucide.createIcons(); document.getElementById("onb-form").onsubmit = async (e) => { e.preventDefault(); await withLoader(document.querySelector(".login-box"), async () => { await supabase.from("users").update({ full_name: e.target.fullName.value, phone: e.target.phone.value, unit: e.target.unit.value, role_status: "Pending" }).eq("id", currentUser.id); await loadData(); setupRealtime(); render(); }); }; }

  function renderApp() {
    const isOwner = currentUser.role === 'OWNER';
    const isManager = currentUser.isManager || isOwner;
    const pendingManagerRequests = users.filter(u => u.requestedManager).length;

    const root = document.getElementById("root");
    root.innerHTML = `
      <div class="app-root">
        <aside class="sidebar">
          <div class="brand"><img src="logo.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/906/906343.png'"><div><div class="brand-title">TicketFlow</div><div style="font-size:0.7rem;color:#94a3b8;">Cyber Ops</div></div></div>
          <div class="nav-group">
            <div class="nav-label">×¨××©×™</div>
            <div class="nav-item ${activePage==='HOME'?'active':''}" onclick="nav('HOME')"><i data-lucide="layout-grid"></i><span>×“×©×‘×•×¨×“</span></div>
            <div class="nav-item ${activePage==='MY_TICKETS'?'active':''}" onclick="nav('MY_TICKETS')"><i data-lucide="list"></i><span>×”×ª×§×œ×•×ª ×©×œ×™</span></div>
            <div class="nav-item ${activePage==='CREATE'?'active':''}" onclick="nav('CREATE')"><i data-lucide="plus-circle"></i><span>×¤×ª×™×—×ª ×ª×§×œ×”</span></div>
          </div>
          <div class="nav-group">
            <div class="nav-label">× ×™×”×•×œ</div>
            ${isManager ? `<div class="nav-item ${activePage==='ALL_TICKETS'?'active':''}" onclick="nav('ALL_TICKETS')"><i data-lucide="layers"></i><span>×›×œ ×”×ª×§×œ×•×ª</span></div>` : ''}
            ${isManager ? `<div class="nav-item ${activePage==='ANALYTICS'?'active':''}" onclick="nav('ANALYTICS')"><i data-lucide="bar-chart-3"></i><span>×× ×œ×™×˜×™×§×”</span></div>` : ''}
            ${isOwner ? `<div class="nav-item ${activePage==='MANAGE_USERS'?'active':''}" onclick="nav('MANAGE_USERS')"><i data-lucide="users"></i><span>× ×™×”×•×œ ××©×ª××©×™×</span> ${pendingManagerRequests > 0 ? `<span class="notification-dot"></span>` : ''}</div>` : ''} 
            ${isOwner ? `<div class="nav-item ${activePage==='ROLE_APPROVAL'?'active':''}" onclick="nav('ROLE_APPROVAL')"><i data-lucide="shield-check"></i><span>××™×©×•×¨ ×ª×¤×§×™×“×™×</span></div>` : ''}
            <div class="nav-item ${activePage==='PROFILE'?'active':''}" onclick="nav('PROFILE')"><i data-lucide="user-circle"></i><span>×¤×¨×•×¤×™×œ ××™×©×™</span></div>
          </div>
          <div class="user-card"><div class="avatar">${(currentUser.fullName?.[0]||'U')}</div><div class="user-info"><div class="user-name">${escapeHtml(currentUser.fullName)}</div><div class="user-role">${currentUser.role === 'OWNER' ? '×‘×¢×œ×™×' : (currentUser.isManager ? '×× ×”×œ ' + roleLabel(currentUser.role) : roleLabel(currentUser.role))}</div></div><button class="logout-btn" onclick="doLogout()"><i data-lucide="log-out"></i></button></div>
        </aside>
        <main class="main" id="main-content"></main>
      </div>`;
    renderPage();
    lucide.createIcons();
  }

  function renderPage() {
    const main = document.getElementById("main-content");
    main.classList.remove("page-animate"); void main.offsetWidth; main.classList.add("page-animate");    
    main.innerHTML = "";
    
    // --- HOME ---
    if(activePage === "HOME") {
      const myOpen = tickets.filter(t => !t.isClosed && (t.createdByUserId===currentUser.id || t.assignedUserId===currentUser.id)).length;
      const totalOpen = tickets.filter(t => !t.isClosed).length;
      const totalClosed = tickets.filter(t => t.isClosed).length;
      const hamalOpen = tickets.filter(t => !t.isClosed && t.isHamalDown).length;
      
      main.innerHTML = `<header class="header"><div><div class="page-title">×‘×•×§×¨ ×˜×•×‘, ${escapeHtml(currentUser.fullName?.split(' ')[0]||'×—×‘×¨')} ğŸ‘‹</div><div class="page-subtitle">×¡×˜×˜×•×¡ ××‘×¦×¢×™ ×¢×“×›× ×™</div></div><button class="btn btn-primary" onclick="nav('CREATE')"><i data-lucide="plus"></i>×ª×§×œ×” ×—×“×©×”</button></header>
      <div class="grid-dashboard">
        <div class="stat-card"><div class="stat-val" style="color:#ec4899;">${myOpen}</div><div class="stat-lbl">×ª×§×œ×•×ª ×©×œ×™</div></div>
        <div class="stat-card"><div class="stat-val" style="color:#8b5cf6;">${totalOpen}</div><div class="stat-lbl">×¡×”×´×› ×¤×ª×•×—×•×ª</div></div>
        <div class="stat-card"><div class="stat-val" style="color:#10b981;">${totalClosed}</div><div class="stat-lbl">×ª×§×œ×•×ª ×©×˜×•×¤×œ×•</div></div>
        <div class="stat-card" style="border-color:${hamalOpen>0?'var(--urgent)':'var(--border)'}"><div class="stat-val" style="color:#ef4444;">${hamalOpen}</div><div class="stat-lbl">××•×©×‘×ª (×—×"×œ)</div></div>
      </div>
      <div class="card"><div class="card-title"><i data-lucide="clock"></i> ×¢×“×›×•× ×™× ××—×¨×•× ×™×</div>${tickets.slice(0,5).map((t,i) => {
         const isLate = !t.isClosed && isOverHour(t.createdAt);
         return `<div class="list-item ${isLate ? 'ticket-urgent' : ''}" style="animation-delay:${i*0.05}s" onclick="nav('DETAILS', '${t.id}')"><div style="display:flex;align-items:center;gap:12px;"><div class="badge badge-${t.status}" style="width:8px;height:8px;padding:0;border-radius:50%;"></div><div><div style="font-weight:600;font-size:0.9rem;">${t.isHamalDown ? 'ğŸš¨ ' : ''}${escapeHtml(t.title)}</div><div style="font-size:0.75rem;color:var(--text-soft);">${timeAgo(t.createdAt)} â€¢ ${escapeHtml(t.createdByName)}</div></div></div><div class="badge badge-${t.status}">${t.status === 'RESOLVED' ? '×˜×•×¤×œ' : (STATUS_LABEL[t.status] || t.status)}</div></div>`;
      }).join('')}</div>`;
    }

    // --- LISTS (WITH SEARCH & FILTER) ---
    if(activePage === "MY_TICKETS" || activePage === "ALL_TICKETS") {
      const isAll = activePage === "ALL_TICKETS";
      if (typeof window.filterState === 'undefined') window.filterState = { search: "", sort: "DESC", topic: "ALL", role: "ALL" };
      window.setSearch = (val) => { window.filterState.search = val.toLowerCase(); render(); }; window.setSort = (val) => { window.filterState.sort = val; render(); }; window.setFilterTopic = (val) => { window.filterState.topic = val; render(); }; window.setFilterRole = (val) => { window.filterState.role = val; render(); }; window.clearFilters = () => { window.filterState = { search: "", sort: "DESC", topic: "ALL", role: "ALL" }; render(); showToast("×”×¡×™× ×•×Ÿ ××•×¤×¡"); };
      
      let list = isAll ? tickets : tickets.filter(t => t.createdByUserId===currentUser.id || t.assignedUserId===currentUser.id || t.assignedRole===currentUser.role);
      list = list.filter(t => t.isClosed === showClosed);

      if (window.filterState.search) list = list.filter(t => (t.title && t.title.toLowerCase().includes(window.filterState.search)) || (t.ticketNumber && t.ticketNumber.toString().includes(window.filterState.search)) || (t.createdByName && t.createdByName.toLowerCase().includes(window.filterState.search)));
      if (window.filterState.topic !== "ALL") list = list.filter(t => t.topic === window.filterState.topic);
      if (window.filterState.role !== "ALL") list = list.filter(t => t.assignedRole === window.filterState.role);
      list.sort((a,b) => { const dateA = new Date(a.createdAt).getTime(); const dateB = new Date(b.createdAt).getTime(); return window.filterState.sort === "DESC" ? dateB - dateA : dateA - dateB; });
      const hasActiveFilters = window.filterState.search !== "" || window.filterState.topic !== "ALL" || window.filterState.role !== "ALL";

      main.innerHTML = `
        <header class="header"><div class="page-title">${isAll?'×›×œ ×”×ª×§×œ×•×ª':'×”×ª×§×œ×•×ª ×©×œ×™'} <span style="font-size:1rem;opacity:0.5;">(${list.length})</span></div><div><button class="btn ${showClosed?'btn-primary':'btn-ghost'}" onclick="toggleClosed()"><i data-lucide="archive"></i> ${showClosed ? '×—×–×¨×” ×œ×¤×ª×•×—×•×ª' : '××¨×›×™×•×Ÿ'}</button></div></header>
        <div class="card" style="padding:16px; margin-bottom:20px; background:rgba(30, 41, 59, 0.7);"><div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;"><div style="font-size:0.85rem; font-weight:600; color:var(--text-soft);">×—×™×¤×•×© ×•×¡×™× ×•×Ÿ</div>${hasActiveFilters ? `<button onclick="clearFilters()" style="background:none; border:none; color:#ec4899; font-size:0.8rem; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:4px;"><i data-lucide="x-circle" style="width:14px; height:14px;"></i> ××™×¤×•×¡</button>` : ''}</div><div style="position:relative; margin-bottom:12px;"><i data-lucide="search" style="position:absolute; right:12px; top:50%; transform:translateY(-50%); color:var(--text-soft); width:18px;"></i><input class="input" placeholder="×”×§×œ×“ ×œ×—×™×¤×•×©..." value="${window.filterState.search}" oninput="setSearch(this.value)" style="padding-right:38px; background:rgba(0,0,0,0.3); border-color:rgba(255,255,255,0.1);" /></div><div style="display:flex; gap:8px; overflow-x:auto; padding-bottom:4px;"><select class="select ${window.filterState.sort!=='DESC'?'active-filter':''}" onchange="setSort(this.value)" style="min-width:110px;"><option value="DESC" ${window.filterState.sort==='DESC'?'selected':''}>ğŸ“… ×—×“×©</option><option value="ASC" ${window.filterState.sort==='ASC'?'selected':''}>ğŸ“… ×™×©×Ÿ</option></select><select class="select ${window.filterState.topic!=='ALL'?'active-filter':''}" onchange="setFilterTopic(this.value)" style="min-width:100px;"><option value="ALL">ğŸ”§ × ×•×©×</option><option value="×—×•××¨×”" ${window.filterState.topic==='×—×•××¨×”'?'selected':''}>×—×•××¨×”</option><option value="×ª×•×›× ×”" ${window.filterState.topic==='×ª×•×›× ×”'?'selected':''}>×ª×•×›× ×”</option><option value="×¨×©×ª" ${window.filterState.topic==='×¨×©×ª'?'selected':''}>×¨×©×ª</option><option value="×”×¨×©××•×ª" ${window.filterState.topic==='×”×¨×©××•×ª'?'selected':''}>×”×¨×©××•×ª</option><option value="××—×¨" ${window.filterState.topic==='××—×¨'?'selected':''}>××—×¨</option></select><select class="select ${window.filterState.role!=='ALL'?'active-filter':''}" onchange="setFilterRole(this.value)" style="min-width:100px;"><option value="ALL">ğŸ‘® ×ª×¤×§×™×“</option><option value="HATAP" ${window.filterState.role==='HATAP'?'selected':''}>×—×˜"×¤</option><option value="HR" ${window.filterState.role==='HR'?'selected':''}>××©"×</option><option value="PLHIK" ${window.filterState.role==='PLHIK'?'selected':''}>×¤×œ×—×™"×§</option><option value="MAMRAM" ${window.filterState.role==='MAMRAM'?'selected':''}>×××¨"×</option></select></div></div>
        
        <div class="card" style="padding:0; background:transparent; border:none; box-shadow:none;">
            ${list.map(t => {
                const isOver1Hour = !t.isClosed && isOverHour(t.createdAt);
                let itemClass = '';
                if (t.isHamalDown) itemClass = 'ticket-hamal';
                else if (isOver1Hour) itemClass = 'ticket-urgent';
                
                return `
                <div class="list-item ${itemClass}" onclick="nav('DETAILS', '${t.id}')">
                  <div style="display:flex; gap:16px; align-items:center;">
                    <div style="font-family:monospace; opacity:0.5; font-size:0.8rem;">#${t.ticketNumber}</div>
                    <div>
                      <div style="font-weight:700; font-size:0.95rem;">${t.isHamalDown ? 'ğŸš¨ ' : ''}${escapeHtml(t.title)}</div>
                      <div style="font-size:0.75rem; color:var(--text-soft); display:flex; gap:8px;">
                        <span>${timeAgo(t.createdAt)}</span> â€¢ <span>${roleLabel(t.assignedRole)}</span>
                        ${isOver1Hour ? '<span style="color:var(--urgent); font-weight:bold;">(×‘×¢×™×›×•×‘)</span>' : ''}
                      </div>
                    </div>
                  </div>
                  <div class="badge badge-${t.status}">${STATUS_LABEL[t.status] || t.status}</div>
                </div>`;
            }).join('')}
            ${list.length === 0 ? '<div style="text-align:center;padding:20px;opacity:0.5;">×œ× × ××¦××• ×ª×§×œ×•×ª</div>' : ''}
            ${tickets.length >= fetchLimit ? `<div style="text-align:center; padding:20px;"><button id="load-more-btn" class="btn btn-ghost" onclick="loadMoreData()">×˜×¢×Ÿ ×ª×§×œ×•×ª ×™×©× ×•×ª ×™×•×ª×¨ <i data-lucide="arrow-down"></i></button></div>` : ''}
        </div>`;
    }

    // --- CREATE ---
    if(activePage === "CREATE") {
      const isSimpleUser = currentUser.role === 'USER';
      const roleOptions = isSimpleUser 
        ? `<option value="HATAP">×—×˜"×¤</option>` 
        : `<option value="HATAP">×—×˜"×¤</option><option value="HR">××©"×</option><option value="PLHIK">×¤×œ×—×™"×§</option><option value="MAMRAM">×××¨"×</option><option value="APP">××¤×œ×™×§×¦×™×”</option><option value="NETWORK">×¨×©×ª</option>`;

      main.innerHTML = `<header class="header"><div class="page-title">×¤×ª×™×—×ª ×§×¨×™××”</div></header><div class="card" style="width:100%;"><form id="create-form">
        <div style="margin-bottom:20px; padding:15px; border:1px solid #ef4444; background:rgba(239,68,68,0.1); border-radius:12px; display:flex; align-items:center; gap:10px;">
            <input type="checkbox" name="hamalDown" id="hamalDown" style="width:20px; height:20px; accent-color:#ef4444;">
            <label for="hamalDown" style="color:#ef4444; font-weight:800; font-size:1.1rem;">ğŸš¨ ×—×"×œ ××•×©×‘×ª (×“×—×™×¤×•×ª ×¢×œ×™×•× ×”)</label>
        </div>
        <div class="grid-2cols"><div class="field-group"><label class="label">× ×•×©×</label><select class="select" name="topic"><option>×—×•××¨×”</option><option>×ª×•×›× ×”</option><option>×¨×©×ª</option><option>×”×¨×©××•×ª</option><option>××—×¨</option></select></div><div class="field-group"><label class="label">×’×•×¨× ××˜×¤×œ</label><select class="select" name="role">${roleOptions}</select></div></div><div class="field-group"><label class="label">×›×•×ª×¨×ª</label><input class="input" name="title" required /></div><div class="field-group"><label class="label">×¤×™×¨×•×˜</label><textarea class="textarea" name="desc" required style="min-height:150px;"></textarea></div><div class="field-group"><label for="file-upload" class="file-upload-label"><i data-lucide="paperclip"></i><span>×¦×¨×£ ×ª××•× ×”...</span></label><input id="file-upload" type="file" accept="image/*" style="display:none;" onchange="this.previousElementSibling.querySelector('span').innerText = this.files[0] ? this.files[0].name : '× ×‘×—×¨ ×§×•×‘×¥'"></div><button class="btn btn-primary" type="submit">×©×œ×— ×§×¨×™××”</button></form></div>`;
      
      document.getElementById("create-form").onsubmit = async (e) => { e.preventDefault(); const fd = new FormData(e.target); const fileFile = document.getElementById("file-upload").files[0]; const isHamal = document.getElementById("hamalDown").checked; 
      await withLoader(document.querySelector(".card"), async () => { 
          let imageUrl = null; 
          if(fileFile) { const fileName = `${Date.now()}_${fileFile.name}`; const { error: upErr } = await supabase.storage.from('attachments').upload(fileName, fileFile); if(!upErr) { const { data } = supabase.storage.from('attachments').getPublicUrl(fileName); imageUrl = data.publicUrl; } } 
          const num = await getNextNum(); 
          const {data:t, error} = await supabase.from("tickets").insert({ ticket_number: num, title: fd.get("title"), description: fd.get("desc"), topic: fd.get("topic"), created_by_user_id: currentUser.id, created_by_name: currentUser.fullName, created_by_email: currentUser.email, unit: currentUser.unit, assigned_role: fd.get("role"), status: "OPEN", is_closed: false, image_url: imageUrl, is_hamal_down: isHamal }).select().single(); 
          if(error) throw error; 
          let notifyTitle = isHamal ? "ğŸš¨ ×—××´×œ ××•×©×‘×ª! ğŸš¨" : "âœ¨ ×ª×§×œ×” ×—×“×©×”";
          const notifyUsers = isHamal ? users.filter(u => u.role === 'OWNER' || u.isManager).map(u => u.id) : getNotifyUserIdsForTicket(t, currentUser.id);
          pushTicketShort({ userIds: notifyUsers, ticketId: num, title: notifyTitle, message: t.title }); 
          await loadData(); nav("DETAILS", t.id); 
      }); };
    }

    // --- DETAILS ---
    if(activePage === "DETAILS") {
      const t = tickets.find(x => x.id == selectedTicketId);
      if(!t) return nav("HOME");
      const isOwner = currentUser.role === 'OWNER';
      const canTakeResponsibility = (t.assignedRole === currentUser.role || isOwner) && t.status === 'OPEN';
      main.innerHTML = `<div style="display:flex;align-items:center;gap:10px;margin-bottom:20px;"><button class="btn" onclick="nav('HOME')"><i data-lucide="chevron-left"></i></button><div class="page-title">×ª×§×œ×” #${t.ticketNumber}</div></div>
      ${t.isHamalDown ? '<div style="background:#ef4444; color:white; padding:15px; border-radius:12px; margin-bottom:20px; font-weight:bold; text-align:center; animation:pulseRed 2s infinite;">ğŸš¨ ×”×ª×¨××”: ×—×"×œ ××•×©×‘×ª</div>' : ''}
      <div class="card">
        ${canTakeResponsibility ? `<button onclick="takeTicket('${t.id}')" class="btn btn-primary" style="width:100%; justify-content:center; margin-bottom:20px; background:#10b981; border-color:#10b981;">âœ‹ ×§×— ×œ×˜×™×¤×•×œ×š (×©×™×•×š ×¢×¦××™)</button>` : ''}
        <div style="font-size:1.2rem;font-weight:700;margin-bottom:10px;">${escapeHtml(t.title)}</div>
        <div style="color:var(--text-soft);margin-bottom:20px;white-space:pre-wrap;">${escapeHtml(t.description)}</div>
        ${t.imageUrl ? `<img src="${t.imageUrl}" class="ticket-image-preview" onclick="window.open('${t.imageUrl}')" />` : ''}
        <div class="grid-2cols" style="background:rgba(255,255,255,0.05);padding:15px;border-radius:12px;">
            <div><span class="label">× ×¤×ª×— ×¢×´×™</span>${escapeHtml(t.createdByName)}</div>
            <div><span class="label">×™×—×™×“×”</span>${escapeHtml(t.unit||'-')}</div>
            <div><span class="label">××—×¨××™</span>${t.assignedUserId ? 'ğŸ‘¤ ××˜×•×¤×œ ×¢"×™ × ×¦×™×’' : roleLabel(t.assignedRole)}</div>
            <div><span class="label">×¡×˜×˜×•×¡</span>${STATUS_LABEL[t.status]}</div>
        </div>
        ${(isOwner || currentUser.isManager || t.assignedRole===currentUser.role) ? `<div style="margin-top:20px; padding-top:20px; border-top:1px solid var(--border);"><div class="label">×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡</div><div style="display:flex; gap:10px;"><select class="select" id="upd-status"><option value="OPEN" ${t.status=='OPEN'?'selected':''}>×¤×ª×•×—</option><option value="IN_PROGRESS" ${t.status=='IN_PROGRESS'?'selected':''}>×‘×˜×™×¤×•×œ</option><option value="RESOLVED" ${t.status=='RESOLVED'?'selected':''}>×˜×•×¤×œ (×¡×’×™×¨×”)</option></select><button class="btn btn-primary" onclick="updateTicket('${t.id}')">×¢×“×›×Ÿ</button></div></div>` : ''}
      </div>
      <div class="card" style="margin-top:20px;">
        <div class="card-title">×™×•××Ÿ ×˜×™×¤×•×œ</div>
        <div style="max-height:300px;overflow-y:auto;margin-bottom:15px;">${comments.filter(c=>c.ticketId==t.id).map(c=>`<div class="chat-bubble"><div class="chat-meta"><b>${escapeHtml(c.authorName)}</b> <span>${formatDate(c.createdAt)}</span></div>${escapeHtml(c.content)}</div>`).join('')}</div>
        <form onsubmit="postComment(event, '${t.id}')" style="display:flex;gap:8px;"><input class="input" name="txt" placeholder="×›×ª×•×‘ ×ª×’×•×‘×”..." required /><button class="btn btn-primary"><i data-lucide="send"></i></button></form>
      </div>`;
    }

    // --- MANAGE USERS ---
    if(activePage === "MANAGE_USERS") {
        if(currentUser.role !== 'OWNER') return nav('HOME');
        main.innerHTML = `<header class="header"><div class="page-title">× ×™×”×•×œ ××©×ª××©×™×</div></header><div class="card" style="overflow-x:auto;"><table class="table"><thead><tr><th>×©×</th><th>×ª×¤×§×™×“</th><th>×× ×”×œ?</th><th>×™×—×™×“×”</th><th>×¡×˜×˜×•×¡</th><th>×”×§×¤××”</th></tr></thead><tbody>${users.map(u => `<tr><td>${escapeHtml(u.fullName)}</td><td>${roleLabel(u.role)}</td><td>
            <div style="display:flex;align-items:center;gap:6px;">
                <input type="checkbox" ${u.isManager?'checked':''} onchange="toggleManager('${u.id}', this.checked)">
                ${u.requestedManager ? '<span class="badge" style="background:#ec4899;color:white;font-size:0.6rem;animation:pulseRed 2s infinite;">××‘×§×©!</span>' : ''}
            </div>
        </td><td>${escapeHtml(u.unit||'-')}</td><td>${u.roleStatus}</td><td><label class="switch"><input type="checkbox" ${u.isFrozen?'checked':''} onchange="toggleFreeze('${u.id}', this.checked)"><span class="slider"></span></label></td></tr>`).join('')}</tbody></table></div>`;
    }

    // --- ANALYTICS (REVISED) ---
    if(activePage === "ANALYTICS") {
        // Date helpers for filtering
        window.setView = (v) => { analyticsView = v; render(); };
        window.moveDate = (dir) => { 
            const d = new Date(analyticsRefDate);
            if(analyticsView === 'WEEK') d.setDate(d.getDate() + (dir * 7));
            else d.setMonth(d.getMonth() + dir);
            analyticsRefDate = d;
            render();
        };

        const getStartEnd = () => {
            const now = new Date(analyticsRefDate);
            let start, end;
            if (analyticsView === 'WEEK') {
                const day = now.getDay(); 
                const diff = now.getDate() - day + (day == 0 ? -6 : 1) -1; // adjust to get Sunday
                start = new Date(now.setDate(diff));
                start.setHours(0,0,0,0);
                end = new Date(start);
                end.setDate(end.getDate() + 6);
                end.setHours(23,59,59,999);
            } else {
                start = new Date(now.getFullYear(), now.getMonth(), 1);
                end = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
            }
            return {start, end};
        };

        const range = getStartEnd();
        const dateLabel = analyticsView === 'WEEK' 
            ? `${range.start.getDate()}/${range.start.getMonth()+1} - ${range.end.getDate()}/${range.end.getMonth()+1}`
            : range.start.toLocaleString('he-IL', { month: 'long', year: 'numeric' });

        // Filter Data
        const isComp = currentUser.role === 'COMPANY_CMD';
        let list = isComp ? tickets.filter(t => (t.unit || "") === (currentUser.unit || "")) : tickets;
        
        // Apply Date Filter
        list = list.filter(t => {
            const d = new Date(t.createdAt);
            return d >= range.start && d <= range.end;
        });

        const open = list.filter(t => !t.isClosed).length;
        const closed = list.filter(t => t.isClosed).length;
        const total = list.length;
        const hamalCount = list.filter(t => t.isHamalDown).length; // ×¡×¤×™×¨×ª ×ª×§×œ×•×ª ××©×‘×™×ª×•×ª
        
        const counts = {};
        list.forEach(t => {
            let key = "××—×¨";
            if (analyticsDim === "STATUS") key = STATUS_LABEL[t.status] || t.status;
            else if (analyticsDim === "ROLE") key = roleLabel(t.assignedRole) || "×œ× ×”×•×§×¦×”";
            else if (analyticsDim === "TOPIC") key = t.topic || "×œ×œ×";
            else if (analyticsDim === "UNIT") key = t.unit || "×›×œ×œ×™";
            counts[key] = (counts[key] || 0) + 1;
        });
        
        const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]); 
        const colors = ["#ec4899", "#8b5cf6", "#3b82f6", "#10b981", "#f59e0b", "#ef4444", "#6366f1", "#14b8a6"];
        let paths = "", startAngle = 0; 
        const pieTotal = total || 1;

        if (sorted.length === 1 && total > 0) { 
            paths = `<circle cx="50" cy="50" r="50" fill="${colors[0]}" class="pie-slice"><title>${sorted[0][0]}</title></circle>`; 
        } else if (total > 0) { 
            sorted.forEach(([label, val], i) => { 
                const pct = val / pieTotal; 
                const sliceAngle = pct * 360; 
                const endAngle = startAngle + sliceAngle; 
                const x1 = 50 + 50 * Math.cos(Math.PI * startAngle / 180); 
                const y1 = 50 + 50 * Math.sin(Math.PI * startAngle / 180); 
                const x2 = 50 + 50 * Math.cos(Math.PI * endAngle / 180); 
                const y2 = 50 + 50 * Math.sin(Math.PI * endAngle / 180); 
                const largeArc = sliceAngle > 180 ? 1 : 0; 
                const d = `M 50 50 L ${x1} ${y1} A 50 50 0 ${largeArc} 1 ${x2} ${y2} Z`; 
                paths += `<path d="${d}" fill="${colors[i % colors.length]}" class="pie-slice" stroke="rgba(15,23,42,0.5)" stroke-width="1"><title>${label}: ${val}</title></path>`; 
                startAngle = endAngle; 
            }); 
        }
        
        main.innerHTML = `
        <div class="page-header"><div class="page-title">×“×©×‘×•×¨×“ ×× ×œ×™×˜×™×§×”</div></div>
        
        <div class="date-control-bar">
            <div style="display:flex;gap:5px;">
                <button class="view-toggle-btn ${analyticsView==='WEEK'?'active':''}" onclick="setView('WEEK')">×©×‘×•×¢</button>
                <button class="view-toggle-btn ${analyticsView==='MONTH'?'active':''}" onclick="setView('MONTH')">×—×•×“×©</button>
            </div>
            <div style="display:flex;align-items:center;gap:15px;font-weight:700;">
                <button class="date-nav-btn" onclick="moveDate(-1)"><i data-lucide="chevron-right"></i></button>
                <span style="min-width:150px;text-align:center;">${dateLabel}</span>
                <button class="date-nav-btn" onclick="moveDate(1)"><i data-lucide="chevron-left"></i></button>
            </div>
        </div>

        <div class="grid-dashboard-compact">
            <div class="stat-card-compact"><div class="stat-val-compact" style="color:#ec4899;">${open}</div><div class="stat-lbl-compact">×¤×ª×•×—×•×ª</div></div>
            <div class="stat-card-compact"><div class="stat-val-compact" style="color:#10b981;">${closed}</div><div class="stat-lbl-compact">×¡×’×•×¨×•×ª</div></div>
            <div class="stat-card-compact"><div class="stat-val-compact" style="color:#f59e0b;">${total}</div><div class="stat-lbl-compact">×¡×”"×› ×œ×ª×§×•×¤×”</div></div>
            <div class="stat-card-compact"><div class="stat-val-compact" style="color:#ef4444;">${hamalCount}</div><div class="stat-lbl-compact">×ª×§×œ×•×ª ××©×‘×™×ª×•×ª</div></div>
        </div>

        <div class="card" style="margin-top:16px;">
            <div class="card-title">×¤×™×œ×•×— × ×ª×•× ×™×</div>
            <div class="analytics-filter-toggle">${[{k:"STATUS",l:"×¡×˜×˜×•×¡"},{k:"ROLE",l:"×ª×¤×§×™×“"},{k:"TOPIC",l:"× ×•×©×"},{k:"UNIT",l:"×—×˜×™×‘×”"}].map(x => `<button class="analytics-filter-chip ${analyticsDim===x.k?'active':''}" onclick="setDim('${x.k}')">${x.l}</button>`).join("")}</div>
            <div class="chart-grid-2">
                <div style="display:flex;align-items:center;justify-content:center;min-height:200px;">
                    ${total > 0 ? `<svg viewBox="-5 -5 110 110" style="width:180px;overflow:visible;transform:rotate(-90deg);">${paths}</svg>` : '<div style="opacity:0.5;">××™×Ÿ × ×ª×•× ×™× ×œ×ª×§×•×¤×” ×–×•</div>'}
                </div>
                <div style="display:flex;flex-direction:column;justify-content:center;">
                    ${sorted.map(([l,v], i) => `<div style="margin-bottom:12px;"><div style="display:flex;align-items:center;justify-content:space-between;font-size:0.85rem;margin-bottom:4px;"><div style="display:flex;align-items:center;gap:8px;"><div style="width:10px;height:10px;border-radius:3px;background:${colors[i%colors.length]}"></div><span>${escapeHtml(l)}</span></div><strong>${v}</strong></div><div style="height:6px;background:rgba(255,255,255,0.05);border-radius:3px;overflow:hidden;"><div style="height:100%;width:${(v/total)*100}%;background:${colors[i%colors.length]};border-radius:3px;"></div></div></div>`).join("")}
                </div>
            </div>
        </div>`;
        window.setDim = (d) => { analyticsDim = d; render(); };
    }

    // --- PROFILE ---
    if(activePage === "PROFILE") {
      const isOwner = currentUser.role === 'OWNER';
      main.innerHTML = `<header class="header"><div class="page-title">×¤×¨×•×¤×™×œ</div></header>
      
      ${currentUser.isManager || isOwner ? `
      <div class="card" style="margin-bottom:20px; background:rgba(16, 185, 129, 0.1); border:1px solid #10b981;">
          <div style="display:flex; align-items:center; gap:12px; color:#10b981;">
              <i data-lucide="shield-check" style="width:32px; height:32px;"></i>
              <div>
                  <div style="font-weight:800; font-size:1.1rem;">${isOwner ? '×‘×¢×œ×™× (Admin)' : '×× ×”×œ ××¢×¨×›×ª (Manager)'}</div>
                  <div style="font-size:0.85rem; opacity:0.8;">×™×© ×œ×š ×”×¨×©××•×ª ××•×¨×—×‘×•×ª ×œ×¦×¤×™×™×” ×•× ×™×”×•×œ.</div>
              </div>
          </div>
      </div>` : ''}

      <div class="card"><form id="profile-form">
        <div class="field-group"><label class="label">×©× ××œ×</label><input class="input" name="fn" value="${escapeHtml(currentUser.fullName)}" /></div>
        <div class="field-group"><label class="label">×˜×œ×¤×•×Ÿ</label><input class="input" name="ph" value="${escapeHtml(currentUser.phone)}" /></div>
        
        <div class="field-group"><label class="label">×—×˜×™×‘×”</label><select class="select" name="unit"><option value="">×œ×œ× ×©×™×•×š</option>${units.map(u=>`<option value="${u.id}" ${currentUser.unitId==u.id?'selected':''}>${escapeHtml(u.name)}</option>`).join('')}</select></div>

        <div class="field-group"><label class="label">×¡×™×¡××” ×—×“×©×” (×œ×”×—×œ×¤×” ×‘×œ×‘×“)</label><input class="input" type="password" name="newPass" placeholder="×”×©××¨ ×¨×™×§ ×›×“×™ ×œ×©××•×¨ ×¢×œ ×”×§×™×™××ª" /></div>

        ${!isOwner && !currentUser.isManager ? `
            <div style="margin:20px 0; padding:15px; border:1px dashed var(--accent); border-radius:12px; text-align:center;">
                <div style="margin-bottom:8px;">×”×× ××ª×” ×× ×”×œ ×‘×ª×¤×§×™×“×š?</div>
                ${currentUser.requestedManager ? '<span style="color:#fbbf24;">â³ ×‘×§×©×” × ×©×œ×—×” (×××ª×™×Ÿ ×œ××™×©×•×¨)</span>' : '<button type="button" class="btn" onclick="requestManager()" style="color:var(--accent);">ğŸ‘® ×‘×§×© ×”×¨×©××ª ×× ×”×œ</button>'}
            </div>` : ''}
        
        <div class="field-group"><label class="label">×ª×¤×§×™×“ (×œ×©×™× ×•×™ ×™×© ×œ×‘×§×© ××™×©×•×¨)</label><select class="select" name="requestedRole">${['HATAP','PLHIK','HR','MAMRAM','APP','NETWORK'].map(r => `<option value="${r}" ${currentUser.requestedRole === r ? "selected" : ""}>${roleLabel(r)}</option>`).join("")}</select></div>
        <div style="background: rgba(236, 72, 153, 0.1); padding: 15px; border-radius: 12px; margin: 20px 0; text-align: center;"><button type="button" class="btn" style="width:100%; justify-content:center; color:#ec4899;" onclick="enableNotificationsManual()"><i data-lucide="bell"></i> ×”×¤×¢×œ ×”×ª×¨××•×ª (iPhone/Android)</button></div>
        <button class="btn btn-primary" style="width:100%;">×©××•×¨ ×©×™× ×•×™×™×</button>
      </form>
      <button class="btn btn-danger" onclick="doLogout()" style="width:100%; margin-top:20px; justify-content:center;"><i data-lucide="log-out"></i> ×”×ª× ×ª×§×•×ª ××”×—×©×‘×•×Ÿ</button>
      </div>`;
      document.getElementById("profile-form").onsubmit = async (e) => { e.preventDefault(); await withLoader(document.querySelector(".card"), async () => { 
          const updates = { full_name: e.target.fn.value, phone: e.target.ph.value, unit_id: e.target.unit.value||null, requested_role: e.target.requestedRole.value, role_status: "Pending" };
          const newPass = e.target.newPass.value;
          if(newPass) { const {error} = await supabase.auth.updateUser({password: newPass}); if(error) throw error; showToast("×¡×™×¡××” ×¢×•×“×›× ×”"); }
          await supabase.from("users").update(updates).eq("id", currentUser.id); await loadData(); showToast("×¤×¨×•×¤×™×œ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”"); 
      }); };
    }
    
    // --- ROLE APPROVAL ---
    if(activePage === "ROLE_APPROVAL") {
        const pending = users.filter(u => u.roleStatus === "Pending");
        main.innerHTML = `<header class="header"><div class="page-title">××™×©×•×¨ ×ª×¤×§×™×“×™×</div></header><div class="card">${pending.length===0 ? '××™×Ÿ ×‘×§×©×•×ª ×××ª×™× ×•×ª' : pending.map(u => `<div class="list-item"><div><b>${escapeHtml(u.fullName)}</b> ××‘×§×© ×œ×¢×‘×•×¨ ×œ-<b>${roleLabel(u.requestedRole)}</b></div><button class="btn btn-primary" onclick="approveRole('${u.id}', '${u.requestedRole}')">××©×¨</button></div>`).join('')}</div>`;
    }
  }

  // --- ACTIONS ---
  window.nav = (p, id=null) => { activePage=p; if(id) selectedTicketId=id; render(); };
  window.toggleClosed = () => { showClosed=!showClosed; render(); };
  window.takeTicket = async (tid) => { await withLoader(document.body, async () => { await supabase.from("tickets").update({ assigned_user_id: currentUser.id, status: "IN_PROGRESS" }).eq("id", tid); await supabase.from("audits").insert({ ticket_id: tid, field: "ASSIGN", new_value: currentUser.fullName, changed_by_name: currentUser.fullName, changed_by_user_id: currentUser.id }); await loadData(); render(); showToast("×”×ª×§×œ×” ×©×•×™×›×” ××œ×™×š ×•×”×•×¢×‘×¨×” ×œ×˜×™×¤×•×œ"); }); };
  window.requestManager = async () => { await supabase.from('users').update({ requested_manager: true }).eq('id', currentUser.id); 
      const owners = users.filter(u => u.role === 'OWNER').map(u => u.id);
      if(owners.length > 0) pushTicketShort({ userIds: owners, ticketId: 0, title: "ğŸ‘® ×‘×§×©×ª ×× ×”×œ ×—×“×©×”", message: `${currentUser.fullName} ×‘×™×§×© ×œ×§×‘×œ ×”×¨×©××•×ª × ×™×”×•×œ.` });
      await loadData(); render(); showToast("×”×‘×§×©×” × ×©×œ×—×” ×œ×‘×¢×œ×™×"); 
  };
  window.toggleFreeze = async (uid, state) => { await supabase.from("users").update({ is_frozen: state }).eq("id", uid); await loadData(); showToast(state ? "××©×ª××© ×”×•×§×¤×" : "××©×ª××© ×”×•×¤×©×¨"); };
  window.toggleManager = async (uid, state) => { await supabase.from("users").update({ is_manager: state, requested_manager: false }).eq("id", uid); await loadData(); showToast("×”×¨×©××•×ª ×¢×•×“×›× ×•"); };
  window.approveRole = async (uid, role) => { await supabase.from("users").update({ role: role, role_status: "Approved", requested_role: null }).eq("id", uid); 
      pushTicketShort({ userIds: [uid], ticketId: 0, title: "ğŸ‰ ×”×ª×¤×§×™×“ ××•×©×¨!", message: `×”×‘×§×©×” ×©×œ×š ×œ×ª×¤×§×™×“ ${roleLabel(role)} ××•×©×¨×” ×‘×”×¦×œ×—×”.` });
      await loadData(); render(); showToast("×”××©×ª××© ××•×©×¨ ×•× ×©×œ×—×” ×œ×• ×”×ª×¨××”");
  };
  window.updateTicket = async (tid) => { const st = document.getElementById("upd-status").value; await supabase.from("tickets").update({ status:st, is_closed:(st==='RESOLVED') }).eq("id", tid); await loadData(); render(); };
  window.postComment = async (e, tid) => { e.preventDefault(); await supabase.from("ticket_comments").insert({ ticket_id: tid, content: e.target.txt.value, author_user_id: currentUser.id, author_name: currentUser.fullName, author_role: currentUser.role }); e.target.reset(); await loadData(); render(); };
  window.doLogout = async () => { localStorage.clear(); sessionStorage.clear(); try { if ("serviceWorker" in navigator) navigator.serviceWorker.ready.then(reg => reg.pushManager.getSubscription().then(sub => sub && sub.unsubscribe())); } catch(e){} try { await supabase.auth.signOut(); } catch(e){} window.location.reload(); };
  window.enableNotificationsManual = async () => { try { if (!("serviceWorker" in navigator)) { alert("âŒ ×©×’×™××”: ×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š ×‘-Service Worker"); return; } if (!("PushManager" in window)) { alert("âŒ ×©×’×™××”: ×”××™×™×¤×•×Ÿ ×œ× ××–×”×” ×ª××™×›×” ×‘-Push. ×”×× ×¤×ª×—×ª ×“×¨×š ××¡×š ×”×‘×™×ª?"); return; } const permission = await Notification.requestPermission(); if (permission !== 'granted') { alert("âš ï¸ ×”××©×ª××© ×œ× ××™×©×¨ ××• ×©×”×”×’×“×¨×•×ª ×—×•×¡××•×ª."); return; } const reg = await navigator.serviceWorker.ready; let sub = await reg.pushManager.getSubscription(); if (!sub) { const res = await fetch(`${PUSH_WORKER_BASE}/publicKey`); if(!res.ok) throw new Error("×œ× ×”×¦×œ×—×ª×™ ×œ×”×‘×™× ××¤×ª×— ×¦×™×‘×•×¨×™ ××”×©×¨×ª"); const { publicKey } = await res.json(); const convertedKey = urlBase64ToUint8Array(publicKey); sub = await reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: convertedKey }); } const saveRes = await fetch(`${PUSH_WORKER_BASE}/subscribe`, { method: "POST", headers: { "content-type": "application/json" }, body: JSON.stringify({ userId: String(currentUser.id), subscription: sub }) }); if (saveRes.ok) alert("ğŸ‰ ×”×¦×œ×—×”! ×”××›×©×™×¨ ×¨×©×•×"); else alert("âŒ ×”×©×¨×ª ×”×—×–×™×¨ ×©×’×™××” ×‘×©××™×¨×”: " + saveRes.status); } catch (err) { alert("ğŸ’€ ×§×¨×¡×” ×”×¤×•× ×§×¦×™×”: " + err.message); console.error(err); } };

  async function getNextNum() { const {data} = await supabase.from("counters").select("value").eq("name","ticketNumber").single(); const next = (data?.value || 1000) + 1; await supabase.from("counters").upsert({name:"ticketNumber", value:next}); return next; }
  function urlBase64ToUint8Array(base64String) { const padding = "=".repeat((4 - (base64String.length % 4)) % 4); const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/"); const rawData = atob(base64); return Uint8Array.from([...rawData].map((c) => c.charCodeAt(0))); }
  async function ensurePushAutoForUser(userId) { if(!("serviceWorker" in navigator)) return; const reg = await navigator.serviceWorker.ready; let sub = await reg.pushManager.getSubscription(); if (!sub) { const { publicKey } = await fetch(`${PUSH_WORKER_BASE}/publicKey`).then(r => r.json()); sub = await reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: urlBase64ToUint8Array(publicKey) }); } await fetch(`${PUSH_WORKER_BASE}/subscribe`, { method: "POST", headers: { "content-type": "application/json" }, body: JSON.stringify({ userId: String(userId), subscription: sub }) }); }
  async function pushTicketShort({ userIds, ticketId, title, message }) { const cleanIds = [...new Set(userIds.map(String).filter(Boolean))]; if (cleanIds.length === 0) return; await fetch(`${PUSH_WORKER_BASE}/sendUsers`, { method: "POST", headers: { "content-type": "application/json" }, body: JSON.stringify({ userIds: cleanIds, title: title, body: message, url: `/?ticket=${ticketId}`, icon: "https://cdn-icons-png.flaticon.com/512/906/906343.png" }) }); }
  function getNotifyUserIdsForTicket(ticket, actingUserId) { const ids = new Set(); if(ticket.createdByUserId && ticket.createdByUserId !== actingUserId) ids.add(ticket.createdByUserId); users.forEach(u => { if(u.role === ticket.assignedRole && !u.isFrozen && u.id !== actingUserId) ids.add(u.id); }); return [...ids]; }

  // ×‘×“×™×§×ª ××¦×‘ ×©×—×–×•×¨ ×‘×˜×¢×™× ×”
  document.addEventListener("DOMContentLoaded", async () => { 
      checkRecoveryMode(); // ×‘×“×™×§×” ×¨××©×•× ×™×ª ×©×œ ×”-Hash
      if ("serviceWorker" in navigator) navigator.serviceWorker.register("/sw.js"); 
      if (!isRecoveryMode) { // ×¨×§ ×× ×× ×—× ×• ×œ× ×‘×©×—×–×•×¨, ×˜×¢×Ÿ × ×ª×•× ×™×
          await loadData(); 
      }
      setupRealtime(); 
      render(); 
  });
</script>
</body>
</html>