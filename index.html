<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>TicketFlow - ××¢×¨×›×ª ×ª×§×œ×•×ª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#0f172a">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root {
      --bg: #020617;
      --text: #f8fafc;
      --text-soft: #94a3b8;
      --accent: #ec4899;
      --card-bg: rgba(30, 41, 59, 0.4);
      --border: rgba(255, 255, 255, 0.08);
      --sidebar-width: 280px;
    }
    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0; padding: 0;
      font-family: 'Heebo', sans-serif;
      background-color: var(--bg);
      background-image: 
        radial-gradient(at 0% 0%, rgba(236,72,153,0.15) 0px, transparent 50%),
        radial-gradient(at 100% 0%, rgba(139,92,246,0.15) 0px, transparent 50%),
        radial-gradient(at 100% 100%, rgba(59,130,246,0.15) 0px, transparent 50%);
      background-attachment: fixed;
      color: var(--text);
      min-height: 100vh;
      display: flex; align-items: stretch; justify-content: center;
    }

    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }

    /* --- LAYOUT --- */
    .app-root {
      width: 100%; max-width: 100%; margin: 0;
      overflow: hidden;
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
      display: flex; flex-direction: row;
      height: 100vh;
      position: relative;
    }

    /* --- SIDEBAR (Desktop Default) --- */
    .sidebar {
      width: var(--sidebar-width); 
      background: rgba(15, 23, 42, 0.95);
      border-inline-start: 1px solid var(--border);
      padding: 24px 20px; 
      display: flex; flex-direction: column; gap: 24px; 
      flex-shrink: 0;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 2000;
    }

    /* --- MOBILE HEADER (Hidden on Desktop) --- */
    .mobile-header {
      display: none; /* ×“×¡×§×˜×•×¤: ××•×¡×ª×¨ */
      height: 60px;
      padding: 0 16px;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(10px);
      position: fixed; top: 0; left: 0; right: 0;
      z-index: 1500;
    }

    .menu-toggle-btn {
      background: transparent; border: none; color: white; cursor: pointer;
      padding: 8px; border-radius: 8px;
    }
    .menu-toggle-btn:active { background: rgba(255,255,255,0.1); }

    /* --- OVERLAY (Mobile only) --- */
    .sidebar-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 1900;
      opacity: 0; pointer-events: none;
      transition: opacity 0.3s;
      backdrop-filter: blur(2px);
    }

    /* --- MOBILE STYLES --- */
    @media (max-width: 900px) {
      .app-root { flex-direction: column; }
      
      .mobile-header { display: flex; } /* ××¦×™×’ ××ª ×”×‘×¨ ×”×¢×œ×™×•×Ÿ */

      .sidebar {
        position: fixed;
        top: 0; bottom: 0; right: 0; /* × ×¦××“ ×œ×™××™×Ÿ */
        width: 280px;
        transform: translateX(100%); /* ××•×¡×ª×¨ ×”×—×•×¦×” ×™××™× ×” */
        border-left: 1px solid var(--border);
        box-shadow: -10px 0 30px rgba(0,0,0,0.5);
      }

      /* ×›×©×”×ª×¤×¨×™×˜ ×¤×ª×•×— */
      .app-root.menu-open .sidebar { transform: translateX(0); }
      .app-root.menu-open .sidebar-overlay { opacity: 1; pointer-events: auto; }

      .main { 
        padding-top: 80px !important; /* ××§×•× ×œ×‘×¨ ×”×¢×œ×™×•×Ÿ */
      }
    }

    /* --- ×›×¤×ª×•×¨ ×¡×’×™×¨×” ×‘×ª×•×š ×”×ª×¤×¨×™×˜ ×œ× ×™×™×“ --- */
    .close-sidebar-btn {
      display: none;
      background: transparent; border: none; color: var(--text-soft);
      position: absolute; top: 20px; left: 20px;
    }
    @media (max-width: 900px) { .close-sidebar-btn { display: block; } }


    /* --- GENERAL STYLES (Same as before) --- */
    .brand { display: flex; align-items: center; gap: 12px; padding: 0 8px; margin-bottom: 8px; }
    .brand img { width: 42px; height: 42px; filter: drop-shadow(0 0 10px rgba(236,72,153,0.4)); }
    .brand-title { font-weight: 800; font-size: 1.2rem; letter-spacing: -0.5px; background: linear-gradient(to right, #fff, #cbd5e1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    
    .nav-group { display: flex; flex-direction: column; gap: 6px; }
    .nav-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-soft); padding: 0 12px; margin-bottom: 4px; font-weight: 600; opacity: 0.6; }
    
    .nav-item {
      display: flex; align-items: center; gap: 12px; padding: 12px 16px;
      border-radius: 14px; cursor: pointer; color: var(--text-soft);
      font-size: 0.9rem; font-weight: 500; transition: all 0.2s;
      border: 1px solid transparent;
    }
    .nav-item:hover { background: rgba(255,255,255,0.03); color: #fff; transform: translateX(-4px); }
    .nav-item.active {
      background: linear-gradient(90deg, rgba(236,72,153,0.15), transparent);
      color: #fff; border-color: rgba(236,72,153,0.2);
    }
    .nav-item svg { width: 20px; height: 20px; transition: transform 0.2s; }
    .nav-item.active svg { color: var(--accent); transform: scale(1.1); }

    .user-card {
      margin-top: auto; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 16px;
      display: flex; align-items: center; gap: 12px; border: 1px solid var(--border);
    }
    .avatar {
      width: 40px; height: 40px; border-radius: 12px; background: linear-gradient(135deg, #f59e0b, #d97706);
      color: #fff; font-weight: 700; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 12px rgba(245,158,11,0.3); font-size: 1rem;
    }
    .user-info { flex: 1; min-width: 0; }
    .user-name { font-size: 0.9rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-role { font-size: 0.75rem; color: var(--text-soft); }
    .logout-btn { background: transparent; border: none; color: var(--text-soft); cursor: pointer; padding: 8px; border-radius: 10px; transition: 0.2s; }
    .logout-btn:hover { background: rgba(244,63,94,0.1); color: #f43f5e; }

    .main { flex: 1; padding: 40px; overflow-y: auto; display: flex; flex-direction: column; gap: 24px; position: relative; }
    @media (max-width: 900px) { .main { padding: 20px; } }

    .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .page-title { font-size: 1.8rem; font-weight: 800; letter-spacing: -0.8px; }
    .page-subtitle { font-size: 0.95rem; color: var(--text-soft); margin-top: 4px; }

    .btn {
      display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px;
      border-radius: 14px; font-size: 0.9rem; font-weight: 600; cursor: pointer;
      border: 1px solid var(--border); background: rgba(255,255,255,0.03); color: var(--text);
      transition: all 0.2s;
    }
    .btn:hover { background: rgba(255,255,255,0.08); transform: translateY(-2px); }
    .btn svg { width: 18px; height: 18px; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    
    .btn-primary {
      background: linear-gradient(135deg, #ec4899, #8b5cf6); border: none; color: white;
      box-shadow: 0 8px 20px -6px rgba(236, 72, 153, 0.5);
    }
    .btn-primary:hover { box-shadow: 0 12px 25px -8px rgba(236, 72, 153, 0.7); transform: translateY(-2px) scale(1.02); }

    .card {
      background: var(--card-bg); border: 1px solid var(--border); border-radius: 24px;
      padding: 32px; box-shadow: 0 10px 30px -10px rgba(0,0,0,0.3);
      transition: transform 0.3s;
      width: 100%;
    }
    .card-title { font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
    
    .field-group { margin-bottom: 20px; width: 100%; }
    .label { display: block; font-size: 0.8rem; font-weight: 600; color: var(--text-soft); margin-bottom: 8px; }
    .input, .select, .textarea {
      width: 100%; background: rgba(0,0,0,0.2); border: 1px solid var(--border);
      border-radius: 14px; padding: 14px 18px; color: #fff; font-family: inherit; font-size: 0.95rem;
      transition: 0.2s;
    }
    .input:focus, .select:focus, .textarea:focus { border-color: var(--accent); background: rgba(0,0,0,0.3); box-shadow: 0 0 0 4px rgba(236,72,153,0.1); }
    .select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: left 16px center; }
    .input:disabled { opacity: 0.6; cursor: not-allowed; background: rgba(255,255,255,0.05); }

    .list-item {
      display: flex; align-items: center; justify-content: space-between; padding: 20px;
      background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 18px;
      margin-bottom: 12px; cursor: pointer; transition: all 0.2s;
      animation: fade-in-up 0.4s ease-out forwards; opacity: 0; transform: translateY(10px);
    }
    .list-item:hover { background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.15); transform: scale(1.005); }
    @keyframes fade-in-up { to { opacity: 1; transform: translateY(0); } }

    .badge { padding: 6px 14px; border-radius: 10px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; display: inline-flex; align-items: center; gap: 6px; }
    .badge-OPEN { background: rgba(59,130,246,0.15); color: #60a5fa; border: 1px solid rgba(59,130,246,0.3); }
    .badge-IN_PROGRESS { background: rgba(245,158,11,0.15); color: #fbbf24; border: 1px solid rgba(245,158,11,0.3); }
    .badge-RESOLVED { background: rgba(34,197,94,0.15); color: #4ade80; border: 1px solid rgba(34,197,94,0.3); }
    .badge-CLOSED { background: rgba(148,163,184,0.15); color: #cbd5e1; border: 1px solid rgba(148,163,184,0.3); }

    .chat-bubble { background: rgba(255,255,255,0.03); border-radius: 18px; padding: 16px; margin-bottom: 14px; border: 1px solid var(--border); }
    .chat-meta { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-size: 0.8rem; color: var(--text-soft); }
    .chat-role { background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 6px; font-size: 0.65rem; }

    .login-wrap { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .login-box { width: 100%; max-width: 440px; padding: 48px; background: rgba(15,23,42,0.6); backdrop-filter: blur(30px); border: 1px solid var(--border); border-radius: 32px; box-shadow: 0 40px 80px -20px rgba(0,0,0,0.5); text-align: center; }
    .login-icon { width: 72px; height: 72px; background: linear-gradient(135deg, #ec4899, #8b5cf6); border-radius: 24px; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; box-shadow: 0 10px 30px rgba(236,72,153,0.4); color: white; }

    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 9999; display: flex; align-items: center; justify-content: center; animation: fade 0.2s; }
    .modal { background: #0f172a; border: 1px solid rgba(255,255,255,0.1); width: 90%; max-width: 400px; padding: 32px; border-radius: 28px; text-align: center; box-shadow: 0 50px 100px -20px rgba(0,0,0,0.8); animation: pop 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    @keyframes pop { from { opacity: 0; transform: scale(0.9) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
    @keyframes fade { from { opacity: 0; } to { opacity: 1; } }

    .loader-wrap { position: absolute; inset: 0; background: rgba(15,23,42,0.8); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 50; border-radius: inherit; }
    .spinner { width: 44px; height: 44px; border: 3px solid rgba(236,72,153,0.1); border-top-color: #ec4899; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .toast { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); background: #1e293b; color: #fff; padding: 14px 28px; border-radius: 99px; box-shadow: 0 20px 40px rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 12px; z-index: 10000; font-weight: 500; animation: slide-up-fade 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    @keyframes slide-up-fade { from { opacity: 0; transform: translate(-50%, 20px); } to { opacity: 1; transform: translate(-50%, 0); } }

    .grid-dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: rgba(255,255,255,0.03); padding: 24px; border-radius: 24px; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 6px; }
    .stat-val { font-size: 2.2rem; font-weight: 800; line-height: 1; }
    .stat-lbl { font-size: 0.8rem; color: var(--text-soft); font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
    
    .analytics-filter-toggle { display: flex; gap: 10px; margin-bottom: 24px; }
    .analytics-filter-chip { padding: 8px 16px; border-radius: 10px; border: 1px solid var(--border); background: transparent; color: var(--text-soft); cursor: pointer; font-size: 0.9rem; transition: 0.2s; }
    .analytics-filter-chip.active { background: rgba(236,72,153,0.2); color: #fff; border-color: rgba(236,72,153,0.4); }
    .pie-slice { transition: transform 0.2s ease-out; cursor: pointer; transform-origin: center; transform-box: fill-box; }
    .pie-slice:hover { transform: scale(1.05); filter: drop-shadow(0 0 8px rgba(236,72,153,0.6)); }
    .chart-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 32px; }
    @media(max-width:900px){ .chart-grid-2 { grid-template-columns: 1fr; } }
    .table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.9rem; }
    .table th { padding: 16px; text-align: right; color: var(--text-soft); font-weight: 600; font-size: 0.8rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .table td { padding: 18px 16px; border-bottom: 1px solid rgba(255,255,255,0.05); transition: background 0.1s; }
    .table tr:last-child td { border-bottom: none; }
    .table tr:hover td { background: rgba(255,255,255,0.03); }
    
    .grid-2cols { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; width: 100%; }
    @media(max-width:700px){ .grid-2cols { grid-template-columns: 1fr; gap: 20px; } }

    /* ×× ×™××¦×™×™×ª ×›× ×™×¡×” ×¨×›×” ×œ×“×¤×™× */
.page-animate {
  animation: pageFadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  opacity: 0; /* ××ª×—×™×œ × ×¡×ª×¨ */
}

@keyframes pageFadeIn {
  from {
    opacity: 0;
    transform: translateY(15px); /* ××ª×—×™×œ ×§×¦×ª ×œ××˜×” */
    filter: blur(2px); /* ×˜×©×˜×•×© ×§×œ ×‘×”×ª×—×œ×” ×œ××¨××” ×™×•×§×¨×ª×™ */
  }
  to {
    opacity: 1;
    transform: translateY(0);
    filter: blur(0);
  }
}
  </style>
</head>
<body>
<div id="root"></div>
<div id="modal-root"></div>
<div id="toast-root"></div>

<script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>

<script>
  const SUPABASE_URL = "https://tymratzaavokyhbcycgb.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR5bXJhdHphYXZva3loYmN5Y2diIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNTE0ODIsImV4cCI6MjA4MDYyNzQ4Mn0.Y73HK3Jgg1FD--o3KMt3A-GbY8S2hfRyr6M-IABu6NY";
  const PUSH_WORKER_BASE = "https://ticketflow-push.galaxyskin350.workers.dev";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let currentUser = null, users = [], tickets = [], comments = [], units = [], activePage = "HOME";
  let showClosed = false, selectedTicketId = null, analyticsDim = "STATUS";

  const escapeHtml = (str) => String(str||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
  const formatDate = (ts) => ts ? new Date(ts).toLocaleString("he-IL", {dateStyle:"short", timeStyle:"short"}) : "";
  const roleLabel = (r) => ({OWNER:"×‘×¢×œ×™×", MANAGER:"×× ×”×œ", COMPANY_CMD:'×"×¤', HATAP:'×—×˜"×¤', HR:'××©"×', USER:"××©×ª××©", PLHIK:'×¤×œ×—×™"×§', MAMRAM:'×××¨"×', APP:'××¤×œ×™×§×¦×™×”', NETWORK:'×¨×©×ª'}[r] || r);
  const STATUS_LABEL = { OPEN:"×¤×ª×•×—", IN_PROGRESS:"×‘×˜×™×¤×•×œ", RESOLVED:"×˜×•×¤×œ", CLOSED:"×¡×’×•×¨" };

  function showToast(msg, icon="check") {
    const el = document.createElement("div"); el.className="toast";
    el.innerHTML = `<i data-lucide="${icon}"></i><span>${msg}</span>`;
    document.getElementById("toast-root").appendChild(el);
    lucide.createIcons();
    setTimeout(() => el.remove(), 3000);
  }

  function showModal(title, msg, isErr=false) {
    return new Promise(resolve => {
      const root = document.getElementById("modal-root");
      root.innerHTML = `
        <div class="modal-overlay">
          <div class="modal" style="border-color:${isErr?'#f43f5e':'rgba(255,255,255,0.1)'}">
            <div style="font-size:3rem;margin-bottom:10px;">${isErr?'ğŸ˜“':'âœ¨'}</div>
            <div style="font-size:1.2rem;font-weight:800;margin-bottom:8px;">${title}</div>
            <div style="color:#94a3b8;margin-bottom:24px;line-height:1.5;">${msg}</div>
            <button class="btn btn-primary" style="width:100%;justify-content:center;" id="mod-ok">×”×‘× ×ª×™, ×¡×’×•×¨</button>
          </div>
        </div>`;
      document.getElementById("mod-ok").onclick = () => { root.innerHTML=""; resolve(); };
    });
  }

  async function withLoader(el, fn) {
    const l = document.createElement("div"); l.className="loader-wrap"; l.innerHTML=`<div class="spinner"></div>`;
    if(getComputedStyle(el).position==="static") el.style.position="relative";
    el.appendChild(l);
    try { await fn(); } catch(e) { console.error(e); showModal("×©×’×™××”", e.message, true); }
    finally { if(l.parentNode===el) el.removeChild(l); }
  }

  async function loadData() {
    const {data:{user}} = await supabase.auth.getUser();
    if(!user) return null;
    
    const [uRes, tRes, cRes, unRes] = await Promise.all([
      supabase.from("users").select("*"),
      supabase.from("tickets").select("*").order("created_at",{ascending:false}),
      supabase.from("ticket_comments").select("*"),
      supabase.from("units").select("*")
    ]);
    
    users = (uRes.data || []).map(u => ({
      id: u.id, authUserId: u.auth_user_id, fullName: u.full_name, email: u.email, phone: u.phone, 
      role: u.role, unit: u.unit, unitId: u.unit_id, requestedRole: u.requested_role, roleStatus: u.role_status, isFrozen: u.is_frozen
    }));

    tickets = (tRes.data || []).map(t => ({
      id: t.id, ticketNumber: t.ticket_number, title: t.title, description: t.description, topic: t.topic,
      status: t.status, unit: t.unit, assignedRole: t.assigned_role, assignedUserId: t.assigned_user_id,
      createdByUserId: t.created_by_user_id, createdByName: t.created_by_name, createdByEmail: t.created_by_email,
      isClosed: !!t.is_closed || t.status === 'RESOLVED' || t.status === 'CLOSED',
      createdAt: t.created_at, updatedAt: t.updated_at
    }));

    comments = (cRes.data || []).map(c => ({
      id: c.id, ticketId: c.ticket_id, content: c.content, authorName: c.author_name, 
      authorRole: c.author_role, authorUserId: c.author_user_id, createdAt: c.created_at
    }));
    units = unRes.data || [];
    
    currentUser = users.find(u => u.authUserId === user.id);
    if(currentUser) ensurePushAutoForUser(currentUser.id).catch(console.error);
    return currentUser;
  }

  // === REALTIME SETUP ===
  function setupRealtime() {
    supabase.channel('public:tickets')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'tickets' }, async (payload) => {
        await loadData();
        render();
        showToast("×”× ×ª×•× ×™× ×”×ª×¢×“×›× ×•", "refresh-cw");
      })
      .on('postgres_changes', { event: '*', schema: 'public', table: 'ticket_comments' }, async (payload) => {
        await loadData();
        render();
      })
      .subscribe();
  }

  function render() {
    if(!currentUser) return renderLogin();
    if(!currentUser.fullName || !currentUser.phone) return renderOnboarding();
    renderApp();
  }

  function renderLogin() {
    document.getElementById("root").innerHTML = `
      <div class="login-wrap">
        <div class="login-box">
          <div class="login-icon"><i data-lucide="shield" style="width:32px;height:32px;"></i></div>
          <h1 style="font-weight:900;font-size:1.8rem;margin-bottom:4px;">TicketFlow</h1>
          <p style="color:#94a3b8;margin-bottom:30px;">××¢×¨×›×ª × ×™×”×•×œ ×ª×§×œ×•×ª ××‘×¦×¢×™×ª</p>
          <form id="auth-form">
            <div class="field-group" style="text-align:right;">
              <label class="label">×›×ª×•×‘×ª ××™××™×™×œ</label>
              <input class="input" type="email" name="email" required />
            </div>
            <div class="field-group" style="text-align:right;">
              <label class="label">×¡×™×¡××”</label>
              <input class="input" type="password" name="password" required />
            </div>
            <button class="btn btn-primary" style="width:100%;justify-content:center;padding:12px;">×›× ×™×¡×” ×œ××¢×¨×›×ª</button>
            <div style="margin-top:16px;font-size:0.8rem;"><span style="color:#64748b;">××™×Ÿ ×œ×š ××©×ª××©?</span> <a href="#" id="go-sign" style="color:#ec4899;text-decoration:none;font-weight:600;">×”×¨×©××”</a></div>
          </form>
        </div>
      </div>`;
    lucide.createIcons();
    const form = document.getElementById("auth-form");
    form.onsubmit = async (e) => {
      e.preventDefault();
      await withLoader(document.querySelector(".login-box"), async () => {
        const { error } = await supabase.auth.signInWithPassword({ email: form.email.value, password: form.password.value });
        if(error) throw error;
        await loadData();
        setupRealtime();
        render();
      });
    };
    document.getElementById("go-sign").onclick = async (e) => {
      e.preventDefault();
      const em = prompt("××™××™×™×œ:"); const pw = prompt("×¡×™×¡××”:");
      if(em&&pw) {
        const {data, error} = await supabase.auth.signUp({email:em, password:pw});
        if(!error) {
           await supabase.from("users").insert({auth_user_id:data.user.id, email:em, role:"USER", role_status:"Pending"});
           showModal("× ×¨×©××ª ×‘×”×¦×œ×—×”", "×›×¢×ª × ×™×ª×Ÿ ×œ×”×ª×—×‘×¨.");
        } else showModal("×©×’×™××”", error.message, true);
      }
    };
  }

  function renderOnboarding() {
    document.getElementById("root").innerHTML = `
      <div class="login-wrap">
        <div class="login-box">
          <div class="login-icon"><i data-lucide="user-plus"></i></div>
          <h2 style="margin-bottom:10px;">×”×©×œ××ª ×¤×¨×•×¤×™×œ</h2>
          <form id="onb-form" style="text-align:right;">
            <div class="field-group"><label class="label">×©× ××œ×</label><input class="input" name="fullName" required value="${escapeHtml(currentUser?.fullName||"")}" /></div>
            <div class="field-group"><label class="label">×˜×œ×¤×•×Ÿ</label><input class="input" name="phone" required value="${escapeHtml(currentUser?.phone||"")}" /></div>
            <div class="field-group"><label class="label">×—×˜×™×‘×”</label><select class="select" name="unit"><option value="">×œ×œ×</option>${units.map(u => `<option value="${escapeHtml(u.name)}">${escapeHtml(u.name)}</option>`).join("")}</select></div>
            <button class="btn btn-primary" style="width:100%;justify-content:center;">×©××™×¨×” ×•×”××©×š</button>
          </form>
        </div>
      </div>
    `;
    lucide.createIcons();
    document.getElementById("onb-form").onsubmit = async (e) => {
      e.preventDefault();
      await withLoader(document.querySelector(".login-box"), async () => {
        await supabase.from("users").update({ full_name: e.target.fullName.value, phone: e.target.phone.value, unit: e.target.unit.value, role_status: "Pending" }).eq("id", currentUser.id);
        await loadData();
        setupRealtime();
        render();
      });
    };
  }

  // --- TOGGLE MENU FUNCTION ---
  window.toggleMenu = () => {
    const root = document.querySelector('.app-root');
    root.classList.toggle('menu-open');
  };

function renderApp() {
    const root = document.getElementById("root");
    
    root.innerHTML = `
      <div class="app-root">
        <header class="mobile-header">
           <button class="menu-toggle-btn" onclick="toggleMenu()"><i data-lucide="menu"></i></button>
           <div class="brand" style="margin:0;">
             <img src="logo.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/906/906343.png'" style="width:32px;height:32px;">
             <span style="font-weight:800;font-size:1.1rem;color:white;">TicketFlow</span>
           </div>
           <div style="width:32px;"></div>
        </header>

        <div class="sidebar-overlay" onclick="toggleMenu()"></div>

        <aside class="sidebar">
          <button class="close-sidebar-btn" onclick="toggleMenu()"><i data-lucide="x"></i></button>
          
          <div class="brand">
            <img src="logo.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/906/906343.png'">
            <div><div class="brand-title">TicketFlow</div><div style="font-size:0.7rem;color:#94a3b8;">V2.0 Pro</div></div>
          </div>
          
          <div class="nav-group">
            <div class="nav-label">×¨××©×™</div>
            <div class="nav-item ${activePage==='HOME'?'active':''}" onclick="nav('HOME')"><i data-lucide="layout-grid"></i><span>×“×©×‘×•×¨×“</span></div>
            <div class="nav-item ${activePage==='MY_TICKETS'?'active':''}" onclick="nav('MY_TICKETS')"><i data-lucide="list"></i><span>×”×ª×§×œ×•×ª ×©×œ×™</span></div>
            <div class="nav-item ${activePage==='CREATE'?'active':''}" onclick="nav('CREATE')"><i data-lucide="plus-circle"></i><span>×¤×ª×™×—×ª ×ª×§×œ×”</span></div>
          </div>
          
          <div class="nav-group">
            <div class="nav-label">× ×™×”×•×œ</div>
            ${['OWNER','MANAGER'].includes(currentUser.role) ? `<div class="nav-item ${activePage==='ALL_TICKETS'?'active':''}" onclick="nav('ALL_TICKETS')"><i data-lucide="layers"></i><span>×›×œ ×”×ª×§×œ×•×ª</span></div>` : ''}
            ${['OWNER','MANAGER','COMPANY_CMD'].includes(currentUser.role) ? `<div class="nav-item ${activePage==='ANALYTICS'?'active':''}" onclick="nav('ANALYTICS')"><i data-lucide="bar-chart-3"></i><span>×× ×œ×™×˜×™×§×”</span></div>` : ''}
            <div class="nav-item ${activePage==='PROFILE'?'active':''}" onclick="nav('PROFILE')"><i data-lucide="user-circle"></i><span>×¤×¨×•×¤×™×œ ××™×©×™</span></div>
            ${currentUser.role === 'OWNER' ? `<div class="nav-item ${activePage==='ROLE_APPROVAL'?'active':''}" onclick="nav('ROLE_APPROVAL')"><i data-lucide="shield-check"></i><span>××™×©×•×¨ ×ª×¤×§×™×“×™×</span></div>` : ''}
          </div>
          
          <div class="user-card">
            <div class="avatar">${(currentUser.fullName?.[0]||'U')}</div>
            <div class="user-info"><div class="user-name">${escapeHtml(currentUser.fullName||'××©×ª××©')}</div><div class="user-role">${roleLabel(currentUser.role)}</div></div>
            <button class="logout-btn" onclick="doLogout()"><i data-lucide="log-out"></i></button>
          </div>
        </aside>

        <main class="main" id="main-content"></main>
      </div>
    `;
    renderPage();
    lucide.createIcons();
  }
  function renderPage() {
    const main = document.getElementById("main-content");
    
    // --- ×”×ª×—×œ×ª ×§×•×“ ×—×“×© ×œ×× ×™××¦×™×” ---
    main.classList.remove("page-animate"); // ××¡×™×¨ ×× ×™××¦×™×” ×§×•×“××ª
    void main.offsetWidth; // "×˜×¨×™×§" ×©××›×¨×™×— ××ª ×”×“×¤×“×¤×Ÿ ×œ×”×‘×™×Ÿ ×©×™×© ×©×™× ×•×™ (Trigger Reflow)
    main.classList.add("page-animate");    // ××•×¡×™×£ ××ª ×”×× ×™××¦×™×” ××—×“×©
    // --- ×¡×•×£ ×§×•×“ ×—×“×© ---

    main.innerHTML = "";
    
    // --- HOME DASHBOARD ---
    if(activePage === "HOME") {
      const myOpen = tickets.filter(t => !t.isClosed && (t.createdByUserId===currentUser.id || t.assignedUserId===currentUser.id)).length;
      const totalOpen = tickets.filter(t => !t.isClosed).length;
      const totalClosed = tickets.filter(t => t.isClosed).length;
      
      main.innerHTML = `
        <header class="header">
          <div><div class="page-title">×‘×•×§×¨ ×˜×•×‘, ${escapeHtml(currentUser.fullName?.split(' ')[0]||'×—×‘×¨')} ğŸ‘‹</div><div class="page-subtitle">×”× ×” ××” ×©×§×•×¨×” ×‘××¢×¨×›×ª ×”×™×•×</div></div>
          <button class="btn btn-primary" onclick="nav('CREATE')"><i data-lucide="plus"></i>×ª×§×œ×” ×—×“×©×”</button>
        </header>
        <div class="grid-dashboard">
          <div class="stat-card"><div class="stat-val" style="color:#ec4899;">${myOpen}</div><div class="stat-lbl">×ª×§×œ×•×ª ×©×× ×™ ×¤×ª×—×ª×™</div></div>
          <div class="stat-card"><div class="stat-val" style="color:#8b5cf6;">${totalOpen}</div><div class="stat-lbl">×¡×”×´×› ×¤×ª×•×—×•×ª</div></div>
          <div class="stat-card"><div class="stat-val" style="color:#10b981;">${totalClosed}</div><div class="stat-lbl">×ª×§×œ×•×ª ×©×˜×•×¤×œ×•</div></div>
        </div>
        <div class="card">
          <div class="card-title"><i data-lucide="clock"></i> ×¢×“×›×•× ×™× ××—×¨×•× ×™×</div>
          ${tickets.slice(0,5).map((t,i) => `
            <div class="list-item" style="animation-delay:${i*0.05}s" onclick="nav('DETAILS', '${t.id}')">
              <div style="display:flex;align-items:center;gap:12px;">
                <div class="badge badge-${t.status}" style="width:8px;height:8px;padding:0;border-radius:50%;"></div>
                <div><div style="font-weight:600;font-size:0.9rem;">${escapeHtml(t.title)}</div><div style="font-size:0.75rem;color:var(--text-soft);">${formatDate(t.createdAt)} â€¢ ${escapeHtml(t.createdByName)}</div></div>
              </div>
              <div class="badge badge-${t.status}">${t.status === 'RESOLVED' ? '×˜×•×¤×œ' : (STATUS_LABEL[t.status] || t.status)}</div>
            </div>`).join('')}
        </div>
      `;
    }

    // --- LISTS ---
    if(activePage === "MY_TICKETS" || activePage === "ALL_TICKETS") {
      const isAll = activePage === "ALL_TICKETS";
      let list = isAll ? tickets : tickets.filter(t => t.createdByUserId===currentUser.id || t.assignedUserId===currentUser.id || t.assignedRole===currentUser.role);
      list = list.filter(t => t.isClosed === showClosed).sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));

      main.innerHTML = `
        <header class="header">
          <div class="page-title">${isAll?'×›×œ ×”×ª×§×œ×•×ª':'×”×ª×§×œ×•×ª ×©×œ×™'} <span style="font-size:1rem;opacity:0.5;">(${list.length})</span></div>
          <div><button class="btn ${showClosed?'btn-primary':'btn-ghost'}" onclick="toggleClosed()"><i data-lucide="filter"></i> ××¨×›×™×•×Ÿ</button></div>
        </header>
        <div class="card" style="padding:0;background:transparent;border:none;box-shadow:none;">
          ${list.length===0 ? `<div style="text-align:center;padding:40px;opacity:0.5;">××™×Ÿ ×ª×§×œ×•×ª ×œ×”×¦×’×”</div>` : 
            list.map((t,i) => `
            <div class="list-item" style="animation-delay:${i*0.05}s" onclick="nav('DETAILS', '${t.id}')">
              <div style="display:flex;gap:16px;align-items:center;">
                <div style="font-family:monospace;opacity:0.5;font-size:0.8rem;">#${t.ticketNumber}</div>
                <div><div style="font-weight:700;font-size:0.95rem;">${escapeHtml(t.title)}</div><div style="font-size:0.75rem;color:var(--text-soft);display:flex;gap:8px;align-items:center;"><span><i data-lucide="user" style="width:12px;display:inline;"></i> ${escapeHtml(t.createdByName)}</span><span>â€¢</span><span>${escapeHtml(t.unit||'×œ×œ× ×™×—×™×“×”')}</span></div></div>
              </div>
              <div class="badge badge-${t.status}">${t.status === 'RESOLVED' ? '×˜×•×¤×œ' : (STATUS_LABEL[t.status] || t.status)}</div>
            </div>`).join('')}
        </div>
      `;
    }

    // --- CREATE TICKET ---
    if(activePage === "CREATE") {
      main.innerHTML = `
        <header class="header"><div class="page-title">×¤×ª×™×—×ª ×§×¨×™××”</div></header>
        <div class="card" style="width:100%;">
          <form id="create-form">
            <div class="grid-2cols">
              <div class="field-group"><label class="label">× ×•×©× ×”×ª×§×œ×”</label><select class="select" name="topic"><option>×—×•××¨×”</option><option>×ª×•×›× ×”</option><option>×¨×©×ª</option><option>×”×¨×©××•×ª</option><option>××—×¨</option></select></div>
              <div class="field-group"><label class="label">×’×•×¨× ××˜×¤×œ</label><select class="select" name="role"><option value="HATAP">×—×˜"×¤</option><option value="HR">××©"×</option></select></div>
            </div>
            <div class="field-group"><label class="label">×›×•×ª×¨×ª (×§×¦×¨ ×•×œ×¢× ×™×™×Ÿ)</label><input class="input" name="title" required placeholder="×œ××©×œ: ×”××“×¤×¡×ª ×‘×œ×©×›×” ×œ× ××•×©×›×ª ×“×£" /></div>
            <div class="field-group"><label class="label">×¤×™×¨×•×˜ ××œ×</label><textarea class="textarea" name="desc" required placeholder="×ª××¨ ××ª ×”×‘×¢×™×”..." style="min-height:150px;"></textarea></div>
            <div style="text-align:left;margin-top:20px;"><button class="btn btn-primary" type="submit"><i data-lucide="send"></i> ×©×œ×— ×§×¨×™××”</button></div>
          </form>
        </div>
      `;
      document.getElementById("create-form").onsubmit = async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        await withLoader(document.querySelector(".card"), async () => {
          const num = await getNextNum();
          const {data:t, error} = await supabase.from("tickets").insert({
            ticket_number: num, title: fd.get("title"), description: fd.get("desc"), topic: fd.get("topic"),
            created_by_user_id: currentUser.id, created_by_name: currentUser.fullName, created_by_email: currentUser.email,
            unit: currentUser.unit, assigned_role: fd.get("role"), status: "OPEN", is_closed: false
          }).select().single();
          if(error) throw error;
          
          try {
              await supabase.from("audits").insert({ 
                  ticket_id: t.id, 
                  field: "CREATE", 
                  new_value: t.title, 
                  changed_by_name: currentUser.fullName,
                  changed_by_user_id: currentUser.id, 
                  changed_by_role: currentUser.role 
              });
          } catch (logErr) { console.warn("Log failed:", logErr); }
          
          pushTicketShort({ 
              userIds: getNotifyUserIdsForTicket(t, currentUser.id), 
              ticketId: num, 
              title: t.title, 
              message: `âœ¨ × ×¤×ª×—×” ×ª×§×œ×” ×—×“×©×” ×¢"×™ ${currentUser.fullName}` 
          });

          await loadData();
          showToast("×”×ª×§×œ×” × ×¤×ª×—×” ×‘×”×¦×œ×—×”!");
          nav("DETAILS", t.id);
        });
      };
    }

    // --- TICKET DETAILS ---
    if(activePage === "DETAILS") {
      const t = tickets.find(x => x.id == selectedTicketId);
      if(!t) return nav("HOME");
      
      const canEdit = ['OWNER','MANAGER'].includes(currentUser.role) || t.assignedRole === currentUser.role || (t.createdByUserId===currentUser.id && t.status==='OPEN');
      
      const allRoles = ['HATAP','HR','PLHIK','MAMRAM','APP','NETWORK'];
      let targets = ['HR'];
      if(['OWNER','MANAGER','HR'].includes(currentUser.role)) targets = allRoles;
      if(t.assignedRole && !targets.includes(t.assignedRole)) targets.push(t.assignedRole);

      main.innerHTML = `
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:20px;">
          <button class="btn btn-ghost" onclick="nav('HOME')"><i data-lucide="chevron-left"></i></button>
          <div class="page-title">×ª×§×œ×” #${t.ticketNumber}</div>
          <div class="badge badge-${t.status}" style="margin-right:auto;font-size:0.9rem;">${t.status === 'RESOLVED' ? '×˜×•×¤×œ' : (STATUS_LABEL[t.status] || t.status)}</div>
        </div>
        <div class="grid-2cols">
          <div class="card" style="height:fit-content;">
            <div class="card-title"><i data-lucide="info"></i> ×¤×¨×˜×™ ×”×§×¨×™××”</div>
            <div style="font-size:1.1rem;font-weight:700;margin-bottom:8px;">${escapeHtml(t.title)}</div>
            <div style="color:var(--text-soft);line-height:1.6;margin-bottom:20px;white-space:pre-wrap;">${escapeHtml(t.description)}</div>
            <div class="grid-2cols" style="background:rgba(0,0,0,0.2);padding:15px;border-radius:12px;margin-bottom:20px;">
              <div><div class="label">× ×¤×ª×— ×¢×´×™</div><div style="display:flex;align-items:center;gap:6px;"><div class="avatar" style="width:24px;height:24px;font-size:0.7rem;">${(t.createdByName||'?')[0]}</div><span>${escapeHtml(t.createdByName)}</span></div></div>
              <div><div class="label">×™×—×™×“×”</div><div>${escapeHtml(t.unit||'-')}</div></div>
              <div style="margin-top:10px;"><div class="label">×ª××¨×™×š</div><div>${formatDate(t.createdAt)}</div></div>
              <div style="margin-top:10px;"><div class="label">××—×¨××™</div><div>${roleLabel(t.assignedRole)}</div></div>
            </div>
            ${canEdit ? `
            <div style="padding-top:20px;border-top:1px solid var(--border);">
              <div class="label" style="margin-bottom:10px;">×˜×™×¤×•×œ ×•× ×™×ª×•×‘</div>
              <div class="grid-2cols" style="gap:10px; margin-bottom:16px;">
                <div>
                    <span class="label" style="font-size:0.75rem;opacity:0.7;">×¡×˜×˜×•×¡</span>
                    <select class="select" id="upd-status" style="width:100%">
                      <option value="OPEN" ${t.status=='OPEN'?'selected':''}>×¤×ª×•×—</option>
                      <option value="IN_PROGRESS" ${t.status=='IN_PROGRESS'?'selected':''}>×‘×˜×™×¤×•×œ</option>
                      <option value="RESOLVED" ${t.status=='RESOLVED'?'selected':''}>×˜×•×¤×œ (×¡×’×™×¨×”)</option>
                    </select>
                </div>
                <div>
                    <span class="label" style="font-size:0.75rem;opacity:0.7;">×”×¢×‘×¨×” ×œ...</span>
                    <select class="select" id="upd-role" style="width:100%">
                       ${targets.map(r => `<option value="${r}" ${t.assignedRole === r ? 'selected' : ''}>${roleLabel(r)}</option>`).join("")}
                    </select>
                </div>
              </div>
              <button class="btn btn-primary" style="width:100%;justify-content:center;" onclick="updateTicket('${t.id}')">×©××•×¨ ×©×™× ×•×™×™×</button>
            </div>` : ''}
          </div>
          <div class="card" style="display:flex;flex-direction:column;height:600px;">
            <div class="card-title"><i data-lucide="message-circle"></i> ×™×•××Ÿ ×˜×™×¤×•×œ</div>
            <div style="flex:1;overflow-y:auto;padding-right:8px;margin-bottom:16px;">
              ${comments.filter(c=>c.ticketId==t.id).map(c => `
                <div class="chat-bubble">
                  <div class="chat-meta"><span style="font-weight:700;color:#fff;">${escapeHtml(c.authorName)}</span><span class="chat-role">${roleLabel(c.authorRole)}</span><span style="margin-right:auto;">${formatDate(c.createdAt)}</span></div>
                  <div style="line-height:1.5;">${escapeHtml(c.content)}</div>
                </div>`).join('')}
              ${comments.filter(c=>c.ticketId==t.id).length===0 ? '<div style="text-align:center;opacity:0.5;margin-top:50px;">××™×Ÿ ×”×¢×¨×•×ª ×¢×“×™×™×Ÿ. ×”×ª×—×œ ×©×™×—×”...</div>' : ''}
            </div>
            <form id="comment-form" style="display:flex;gap:8px;">
              <input class="input" name="txt" placeholder="×›×ª×•×‘ ×¢×“×›×•×Ÿ..." autocomplete="off" required />
              <button class="btn btn-primary"><i data-lucide="send"></i></button>
            </form>
          </div>
        </div>
      `;
      
      const cf = document.getElementById("comment-form");
      if(cf) cf.onsubmit = async (e) => {
        e.preventDefault();
        await withLoader(cf.parentNode, async () => {
          await supabase.from("ticket_comments").insert({ ticket_id: t.id, content: cf.txt.value, author_user_id: currentUser.id, author_name: currentUser.fullName, author_role: currentUser.role });
          
          pushTicketShort({ 
              userIds: getNotifyUserIdsForTicket(t, currentUser.id), 
              ticketId: t.ticketNumber, 
              title: t.title, 
              message: `ğŸ’¬ ×ª×’×•×‘×” ×—×“×©×” ×××ª ${currentUser.fullName}: ${cf.txt.value}` 
          });
          
          await loadData();
          renderPage();
        });
      };
    }

    // --- PROFILE ---
    if(activePage === "PROFILE") {
      const isOwner = currentUser.role === 'OWNER';
      main.innerHTML = `
        <header class="header"><div class="page-title">×”×’×“×¨×•×ª ×¤×¨×•×¤×™×œ</div></header>
        <div class="card" style="width:100%;">
          <form id="profile-form">
            <div class="grid-2cols">
              <div class="field-group"><label class="label">×©× ××œ×</label><input class="input" name="fn" value="${escapeHtml(currentUser.fullName)}" /></div>
              <div class="field-group"><label class="label">××¡×¤×¨ ×˜×œ×¤×•×Ÿ</label><input class="input" name="ph" value="${escapeHtml(currentUser.phone)}" /></div>
            </div>
            <div class="field-group"><label class="label">×—×˜×™×‘×”</label><select class="select" name="unit"><option value="">×œ×œ× ×©×™×•×š</option>${units.map(u=>`<option value="${u.id}" ${currentUser.unitId==u.id?'selected':''}>${escapeHtml(u.name)}</option>`).join('')}</select></div>
            <hr style="border:none;border-bottom:1px solid var(--border);margin:20px 0;"/>
            
            <div style="background: rgba(236, 72, 153, 0.1); padding: 15px; border-radius: 12px; border: 1px dashed #ec4899; margin-bottom: 20px; text-align: center;">
                <div style="font-weight:bold; margin-bottom:8px; color:#ec4899;">×‘×“×™×§×ª ×”×ª×¨××•×ª ×œ××™×™×¤×•×Ÿ</div>
                <button type="button" class="btn" style="width:100%; justify-content:center; background:#ec4899; color:white;" onclick="enableNotificationsManual()">
                    <i data-lucide="bell"></i> ×œ×—×¥ ×›××Ÿ ×œ×”×¤×¢×œ×ª ×”×ª×¨××•×ª
                </button>
                <div style="font-size:0.75rem; margin-top:8px; opacity:0.7;">×—×•×‘×” ×œ×œ×—×•×¥ ×›××Ÿ ×›×“×™ ×œ××©×¨ ×”×¨×©××” ×‘××™×™×¤×•×Ÿ</div>
            </div>

            <div class="field-group"><label class="label">××™××™×™×œ</label><input class="input" value="${escapeHtml(currentUser.email)}" disabled /></div>
            <div class="grid-2cols">
               <div class="field-group"><label class="label">×ª×¤×§×™×“ × ×•×›×—×™</label><input class="input" value="${roleLabel(currentUser.role)}" disabled /></div>
               <div class="field-group"><label class="label">×¡×˜×˜×•×¡ ×‘×§×©×”</label><input class="input" value="${currentUser.roleStatus}" disabled /></div>
            </div>
            <div class="field-group"><label class="label">×‘×§×©×” ×œ×ª×¤×§×™×“ ××—×¨</label><select class="select" name="requestedRole" ${isOwner ? "disabled" : ""}>${['MANAGER','COMPANY_CMD','HATAP','PLHIK','HR','MAMRAM','APP','NETWORK','USER'].map(r => `<option value="${r}" ${currentUser.requestedRole === r ? "selected" : ""}>${roleLabel(r)}</option>`).join("")}</select></div>
            <button class="btn btn-primary">×©××•×¨ ×©×™× ×•×™×™×</button>
          </form>
        </div>
      `;
      document.getElementById("profile-form").onsubmit = async (e) => {
        e.preventDefault();
        await withLoader(document.querySelector(".card"), async () => {
          await supabase.from("users").update({ full_name: e.target.fn.value, phone: e.target.ph.value, unit_id: e.target.unit.value || null, requested_role: isOwner ? currentUser.requestedRole : e.target.requestedRole.value, role_status: (!isOwner && e.target.requestedRole.value!==currentUser.role) ? "Pending" : currentUser.roleStatus }).eq("id", currentUser.id);
          await loadData();
          showToast("×”×¤×¨×•×¤×™×œ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”");
        });
      };
    }

    // --- ROLE APPROVAL ---
    if(activePage === "ROLE_APPROVAL") {
      const pending = users.filter(u => u.roleStatus === "Pending" && u.requestedRole !== u.role);
      main.innerHTML = `<div class="page-header"><div class="page-title">××™×©×•×¨ ×ª×¤×§×™×“×™×</div></div><div class="card">${!pending.length ? `<div style="padding:20px;text-align:center;opacity:0.6;">××™×Ÿ ×‘×§×©×•×ª ×××ª×™× ×•×ª</div>` : `<table class="table"><thead><tr><th>×©×</th><th>×ª×¤×§×™×“ ××‘×•×§×©</th><th>×¤×¢×•×œ×•×ª</th></tr></thead><tbody>${pending.map(u => `<tr><td>${escapeHtml(u.fullName)}</td><td><span class="badge badge-IN_PROGRESS">${roleLabel(u.requestedRole)}</span></td><td><button class="btn btn-primary" onclick="approve('${u.id}','${u.requestedRole}')">××©×¨</button></td></tr>`).join("")}</tbody></table>`}</div>`;
    }

    // --- ANALYTICS ---
    if(activePage === "ANALYTICS") {
      renderAnalytics(main);
    } else {
        lucide.createIcons();
    }
  }

  function renderAnalytics(container) {
    const isComp = currentUser.role === 'COMPANY_CMD';
    const list = isComp ? tickets.filter(t => (t.unit || "") === (currentUser.unit || "")) : tickets;
    if (list.length === 0) { container.innerHTML = `<div class="page-header"><div class="page-title">×“×©×‘×•×¨×“ ×× ×œ×™×˜×™×§×”</div></div><div class="card" style="text-align:center;padding:40px;opacity:0.6;"><div>××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”</div></div>`; return; }
    
    const open = list.filter(t => !t.isClosed).length;
    const closed = list.filter(t => t.isClosed).length;
    const week = list.filter(t => t.createdAt && new Date(t.createdAt) >= new Date(Date.now() - 7*864e5)).length;
    const counts = {};
    list.forEach(t => {
      let key = "××—×¨";
      if (analyticsDim === "STATUS") key = STATUS_LABEL[t.status] || t.status;
      else if (analyticsDim === "ROLE") key = roleLabel(t.assignedRole) || "×œ× ×”×•×§×¦×”";
      else if (analyticsDim === "TOPIC") key = t.topic || "×œ×œ×";
      else if (analyticsDim === "UNIT") key = t.unit || "×›×œ×œ×™";
      counts[key] = (counts[key] || 0) + 1;
    });
    
    const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]);
    const total = list.length || 1;
    const colors = ["#ec4899", "#8b5cf6", "#3b82f6", "#10b981", "#f59e0b", "#ef4444", "#6366f1", "#14b8a6"];
    let paths = "", startAngle = 0;
    
    if (sorted.length === 1 && total > 0) {
        paths = `<circle cx="50" cy="50" r="50" fill="${colors[0]}" class="pie-slice"><title>${sorted[0][0]}</title></circle>`;
    } else if (total > 0) {
        sorted.forEach(([label, val], i) => {
          const pct = val / total;
          const sliceAngle = pct * 360;
          const endAngle = startAngle + sliceAngle;
          const x1 = 50 + 50 * Math.cos(Math.PI * startAngle / 180);
          const y1 = 50 + 50 * Math.sin(Math.PI * startAngle / 180);
          const x2 = 50 + 50 * Math.cos(Math.PI * endAngle / 180);
          const y2 = 50 + 50 * Math.sin(Math.PI * endAngle / 180);
          const largeArc = sliceAngle > 180 ? 1 : 0;
          const d = `M 50 50 L ${x1} ${y1} A 50 50 0 ${largeArc} 1 ${x2} ${y2} Z`;
          paths += `<path d="${d}" fill="${colors[i % colors.length]}" class="pie-slice" stroke="rgba(15,23,42,0.5)" stroke-width="1"><title>${label}: ${val}</title></path>`;
          startAngle = endAngle;
        });
    }

    container.innerHTML = `
      <div class="page-header"><div class="page-title">×“×©×‘×•×¨×“ ×× ×œ×™×˜×™×§×”</div></div>
      <div class="analytics-kpi-row" style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;">
        <div class="analytics-kpi-card"><div class="analytics-kpi-label">×¤×ª×•×—×•×ª</div><div class="analytics-kpi-value">${open}</div></div>
        <div class="analytics-kpi-card"><div class="analytics-kpi-label">×¡×’×•×¨×•×ª</div><div class="analytics-kpi-value">${closed}</div></div>
        <div class="analytics-kpi-card"><div class="analytics-kpi-label">×”×©×‘×•×¢</div><div class="analytics-kpi-value">${week}</div></div>
        <div class="analytics-kpi-card"><div class="analytics-kpi-label">×¡×”"×›</div><div class="analytics-kpi-value">${list.length}</div></div>
      </div>
      <div class="card" style="margin-top:16px;">
        <div class="card-header"><div class="card-title">×¤×™×œ×•×— × ×ª×•× ×™×</div><div class="analytics-filter-toggle">${[{k:"STATUS",l:"×¡×˜×˜×•×¡"},{k:"ROLE",l:"×ª×¤×§×™×“"},{k:"TOPIC",l:"× ×•×©×"},{k:"UNIT",l:"×—×˜×™×‘×”"}].map(x => `<button class="analytics-filter-chip ${analyticsDim===x.k?'active':''}" onclick="setDim('${x.k}')">${x.l}</button>`).join("")}</div></div>
        <div class="chart-grid-2">
          <div style="display:flex;align-items:center;justify-content:center;"><svg viewBox="-5 -5 110 110" style="width:220px;overflow:visible;transform:rotate(-90deg);">${paths}</svg></div>
          <div style="display:flex;flex-direction:column;justify-content:center;">${sorted.map(([l,v], i) => `<div style="margin-bottom:12px;"><div style="display:flex;align-items:center;justify-content:space-between;font-size:0.85rem;margin-bottom:4px;"><div style="display:flex;align-items:center;gap:8px;"><div style="width:10px;height:10px;border-radius:3px;background:${colors[i%colors.length]}"></div><span>${escapeHtml(l)}</span></div><strong>${v}</strong></div><div style="height:6px;background:rgba(255,255,255,0.05);border-radius:3px;overflow:hidden;"><div style="height:100%;width:${(v/total)*100}%;background:${colors[i%colors.length]};border-radius:3px;"></div></div></div>`).join("")}</div>
        </div>
      </div>
    `;
    lucide.createIcons();
    window.setDim = (d) => { analyticsDim = d; render(); };
  }

  window.nav = (p, id=null) => { activePage=p; if(id) selectedTicketId=id; render(); };
  window.toggleClosed = () => { showClosed=!showClosed; render(); };
  window.doLogout = async () => { await supabase.auth.signOut(); location.reload(); };
  window.setDim = (d) => { analyticsDim=d; render(); };
  window.approve = async (uid, role) => { await withLoader(document.body, async () => { await supabase.from("users").update({ role, role_status: "Approved" }).eq("id", uid); await loadData(); render(); showToast("×”××©×ª××© ××•×©×¨"); }); };
  
  // --- ×¤×•× ×§×¦×™×™×ª ×¢×“×›×•×Ÿ ×˜×™×§×˜ (×”×•×¦××” ×”×—×•×¦×” ×›× ×“×¨×©) ---
  window.updateTicket = async (tid) => {
    const st = document.getElementById("upd-status").value;
    const rl = document.getElementById("upd-role").value;
    const isClosed = (st === 'RESOLVED');
    
    await withLoader(document.querySelector(".card"), async () => {
      const { data: updatedTicket, error } = await supabase.from("tickets")
        .update({ status:st, is_closed:isClosed, assigned_role:rl })
        .eq("id", tid)
        .select().single();
        
      if(error) throw error;

      try {
          await supabase.from("audits").insert({ 
              ticket_id: tid, 
              field: "UPDATE", 
              new_value: `×¡×˜×˜×•×¡: ${st}, ×”×•×¢×‘×¨ ×œ: ${roleLabel(rl)}`, 
              changed_by_name: currentUser.fullName, 
              changed_by_user_id: currentUser.id, 
              changed_by_role: currentUser.role 
          });
      } catch (logErr) { console.warn(logErr); }

      const changeText = isClosed ? "×”×¡×˜×˜×•×¡ ×©×•× ×” ×œ-×¡×’×•×¨ ğŸ”’" : `×”×¡×˜×˜×•×¡ ×¢×•×“×›×Ÿ ×œ-${STATUS_LABEL[st] || st}`;
      const ticketTitle = updatedTicket?.title || `×ª×§×œ×” #${updatedTicket?.ticket_number}`;

      pushTicketShort({ 
          userIds: getNotifyUserIdsForTicket(updatedTicket, currentUser.id), 
          ticketId: updatedTicket.ticket_number, 
          title: ticketTitle, 
          message: `ğŸ”„ ${changeText}`
      });

      await loadData(); render(); showToast("×”×ª×§×œ×” ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”!");
    });
  };
  
  async function getNextNum() {
    const {data} = await supabase.from("counters").select("value").eq("name","ticketNumber").single();
    const next = (data?.value || 1000) + 1;
    await supabase.from("counters").upsert({name:"ticketNumber", value:next});
    return next;
  }

  // --- PUSH HELPERS ---
  function urlBase64ToUint8Array(base64String) { const padding = "=".repeat((4 - (base64String.length % 4)) % 4); const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/"); const rawData = atob(base64); return Uint8Array.from([...rawData].map((c) => c.charCodeAt(0))); }
  async function ensurePushAutoForUser(userId) { if(!("serviceWorker" in navigator)) return; const reg = await navigator.serviceWorker.ready; let sub = await reg.pushManager.getSubscription(); if (!sub) { const { publicKey } = await fetch(`${PUSH_WORKER_BASE}/publicKey`).then(r => r.json()); sub = await reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: urlBase64ToUint8Array(publicKey) }); } await fetch(`${PUSH_WORKER_BASE}/subscribe`, { method: "POST", headers: { "content-type": "application/json" }, body: JSON.stringify({ userId: String(userId), subscription: sub }) }); }
  
  async function pushTicketShort({ userIds, ticketId, title, message }) { 
      const cleanIds = [...new Set(userIds.map(String).filter(Boolean))];
      if (cleanIds.length === 0) { console.log("No users to notify"); return; }
      
      await fetch(`${PUSH_WORKER_BASE}/sendUsers`, { 
          method: "POST", 
          headers: { "content-type": "application/json" }, 
          body: JSON.stringify({ 
              userIds: cleanIds, 
              title: title,
              body: message,
              url: `/?ticket=${ticketId}`,
              icon: "https://cdn-icons-png.flaticon.com/512/906/906343.png"
          }) 
      }); 
  }
  
  function getNotifyUserIdsForTicket(ticket, actingUserId) {
    const ids = new Set();
    const creatorId = ticket.createdByUserId || ticket.created_by_user_id;
    const assigneeId = ticket.assignedUserId || ticket.assigned_user_id;
    const role = ticket.assignedRole || ticket.assigned_role;

    if(creatorId && creatorId !== actingUserId) ids.add(creatorId);
    if(assigneeId && assigneeId !== actingUserId) ids.add(assigneeId);
    
    else if (role) {
        users.forEach(u => {
            if(u.role === role && !u.isFrozen && u.id !== actingUserId) ids.add(u.id);
        });
    }
    return [...ids];
  }

  async function enableNotificationsManual() {
    try {
      if (!("serviceWorker" in navigator)) { alert("âŒ ×©×’×™××”: ×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š ×‘-Service Worker"); return; }
      if (!("PushManager" in window)) { alert("âŒ ×©×’×™××”: ×”××™×™×¤×•×Ÿ ×œ× ××–×”×” ×ª××™×›×” ×‘-Push. ×”×× ×¤×ª×—×ª ×“×¨×š ××¡×š ×”×‘×™×ª?"); return; }

      const permission = await Notification.requestPermission();
      if (permission !== 'granted') { alert("âš ï¸ ×”××©×ª××© ×œ× ××™×©×¨ ××• ×©×”×”×’×“×¨×•×ª ×—×•×¡××•×ª."); return; }

      const reg = await navigator.serviceWorker.ready;
      let sub = await reg.pushManager.getSubscription();
      
      if (!sub) {
          const res = await fetch(`${PUSH_WORKER_BASE}/publicKey`);
          if(!res.ok) throw new Error("×œ× ×”×¦×œ×—×ª×™ ×œ×”×‘×™× ××¤×ª×— ×¦×™×‘×•×¨×™ ××”×©×¨×ª");
          const { publicKey } = await res.json();
          const convertedKey = urlBase64ToUint8Array(publicKey);
          sub = await reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: convertedKey });
      }

      const saveRes = await fetch(`${PUSH_WORKER_BASE}/subscribe`, {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ userId: String(currentUser.id), subscription: sub })
      });

      if (saveRes.ok) alert("ğŸ‰ ×”×¦×œ×—×”! ×”××›×©×™×¨ ×¨×©×•×");
      else alert("âŒ ×”×©×¨×ª ×”×—×–×™×¨ ×©×’×™××” ×‘×©××™×¨×”: " + saveRes.status);

    } catch (err) {
      alert("ğŸ’€ ×§×¨×¡×” ×”×¤×•× ×§×¦×™×”: " + err.message);
      console.error(err);
    }
  }

  document.addEventListener("DOMContentLoaded", async () => {
    if ("serviceWorker" in navigator) navigator.serviceWorker.register("/sw.js");
    await loadData();
    setupRealtime();
    render();
  });
</script>
</body>
</html>